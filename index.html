<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NANDOmode - Learn Spanish Vocabulary</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Press Start 2P', cursive, 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        #game-container {
            max-width: 900px;
            width: 100%;
            background: rgba(10, 15, 30, 0.85);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            position: relative;
            border: 6px solid #4a4a8a;
        }
        
        .screen {
            display: none;
            padding: 30px 20px;
            min-height: 600px;
        }
        
        .active {
            display: block;
        }
        
        h1, h2, h3 {
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.7);
            font-weight: bold;
            line-height: 1.3;
        }
        
        h1 {
            font-size: 2.8rem;
            margin: 25px 0 15px;
            letter-spacing: 4px;
            color: #f8f8f8;
            text-transform: uppercase;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #ffe66d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
        }
        
        h2 {
            font-size: 2rem;
            margin: 20px 0;
            color: #ffe66d;
        }
        
        h3 {
            font-size: 1.5rem;
            margin: 15px 0;
            color: #4ecdc4;
        }
        
        button {
            background: linear-gradient(145deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.3rem;
            font-family: inherit;
            cursor: pointer;
            margin: 15px;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            border: 3px solid #ff4757;
        }
        
        button:hover {
            transform: translateY(-4px);
            background: linear-gradient(145deg, #ff8e8e, #ff6b6b);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        
        .btn-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 25px 0;
        }
        
        .mode-btn {
            min-width: 200px;
            margin: 12px;
            padding: 18px;
            font-size: 1.2rem;
            border-radius: 15px;
        }
        
        .mode-btn.easy { 
            background: linear-gradient(145deg, #3a7, #4bc); 
            border: 3px solid #2aa;
        }
        .mode-btn.medium { 
            background: linear-gradient(145deg, #47a, #58c); 
            border: 3px solid #36b;
        }
        .mode-btn.hard { 
            background: linear-gradient(145deg, #a54, #d66); 
            border: 3px solid #c33;
        }
        
        #start-screen {
            background: radial-gradient(circle at center, #1e3a5f, #132238);
            text-align: center;
        }
        
        .username-container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 3px solid #4ecdc4;
        }
        
        #username-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3rem;
            font-family: inherit;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            margin: 15px 0;
        }
        
        .avatar-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .avatar {
            font-size: 5rem;
            margin: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 3px solid transparent;
            animation: avatarPulse 2s infinite ease-in-out;
        }
        
        .avatar:hover {
            transform: scale(1.15);
            background: rgba(255, 255, 255, 0.1);
            animation: none;
        }
        
        .avatar.selected {
            transform: scale(1.25);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.8);
            border: 3px solid #ffe66d;
            animation: none;
        }
        
        @keyframes avatarPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .color-picker {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .color-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 12px;
            cursor: pointer;
            border: 3px solid #555;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            transform: scale(1.25);
            border: 4px solid white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        
        #game-screen {
            background: radial-gradient(circle at center, #1a2a3a, #0d1b2a);
        }
        
        .game-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 3px solid #4a4a8a;
        }
        
        .game-header div {
            font-size: 1.2rem;
            text-align: center;
            padding: 10px 5px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            border: 2px solid #4ecdc4;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .player-avatar {
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .game-header .progress-container {
            grid-column: 1 / span 4;
            width: 100%;
            margin: 10px 0 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            height: 30px;
            border: 2px solid #4a4a8a;
            overflow: hidden;
            padding: 0;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .game-board {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            min-height: 400px;
            gap: 20px;
        }
        
        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: rgba(30, 40, 70, 0.8);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 120px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            border: 3px solid rgba(100, 100, 200, 0.3);
        }
        
        .card:hover {
            transform: translateY(-5px);
            background: rgba(40, 50, 90, 0.9);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            border-color: rgba(100, 200, 255, 0.5);
        }
        
        .card.selected {
            background: rgba(100, 200, 255, 0.3);
            box-shadow: 0 0 20px rgba(100, 200, 255, 0.6);
            border: 3px solid rgba(100, 200, 255, 0.7);
        }
        
        .card.correct {
            background: rgba(100, 255, 100, 0.3);
            animation: pulse 0.5s ease;
        }
        
        .card.incorrect {
            background: rgba(255, 100, 100, 0.3);
            animation: shake 0.5s ease;
        }
        
        .card.matched {
            background: rgba(100, 255, 100, 0.5);
            border: 3px solid #4ecdc4;
            box-shadow: 0 0 15px rgba(100, 255, 100, 0.8);
            pointer-events: none;
            cursor: default;
        }
        
        .emoji-card {
            font-size: 3.5rem;
        }
        
        .word-card {
            font-size: 1.6rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 15px;
        }
        
        #round-end-screen {
            background: radial-gradient(circle at center, #2a3a2a, #1a2a1a);
            text-align: center;
        }
        
        .round-result {
            font-size: 1.8rem;
            margin: 30px 0;
            padding: 25px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: 3px solid #4ecdc4;
            max-width: 600px;
            margin: 30px auto;
        }
        
        .confetti {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            animation: fall 3s linear forwards;
        }
        
        #leaderboard-screen {
            background: radial-gradient(circle at center, #2a2a3a, #1a1a2a);
        }
        
        .leaderboard-container {
            max-width: 700px;
            margin: 20px auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            border: 3px solid #4ecdc4;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(30, 30, 60, 0.6);
            border-radius: 10px;
            overflow: hidden;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(100, 100, 200, 0.3);
        }
        
        th {
            background: rgba(50, 50, 100, 0.8);
            color: #ffe66d;
        }
        
        tr:nth-child(even) {
            background: rgba(40, 40, 80, 0.4);
        }
        
        .leaderboard-avatar {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        #game-over-screen {
            background: radial-gradient(circle at center, #3a2a2a, #2a1a1a);
            text-align: center;
        }
        
        .milestone-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #ffe66d;
            padding: 15px 30px;
            border-radius: 10px;
            border: 3px solid #4ecdc4;
            font-size: 1.2rem;
            z-index: 1000;
            animation: fadeInOut 3s ease forwards;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(100, 255, 100, 0.6); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px rgba(100, 255, 100, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(100, 255, 100, 0.6); }
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-15px); }
            50% { transform: translateX(15px); }
            75% { transform: translateX(-15px); }
            100% { transform: translateX(0); }
        }
        
        @keyframes fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(800px) rotate(360deg); opacity: 0; }
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            h2 { font-size: 1.6rem; }
            h3 { font-size: 1.2rem; }
            
            .game-header {
                grid-template-columns: 1fr 1fr;
            }
            
            .game-header div:nth-child(1), .game-header div:nth-child(2) {
                grid-column: 1 / span 2;
            }
            
            .game-header .progress-container {
                grid-column: 1 / span 2;
            }
            
            .game-board {
                flex-direction: row;
                gap: 10px;
            }
            
            .column {
                flex: 1;
                min-width: 45%;
            }
            
            .card {
                height: 100px;
                padding: 10px;
            }
            
            .emoji-card { font-size: 2.5rem; }
            .word-card { font-size: 1.2rem; }
            
            button { padding: 12px 20px; font-size: 1.1rem; }
            .mode-btn { min-width: 160px; padding: 15px; }
            
            .avatar { font-size: 4rem; margin: 8px; }
            .player-avatar { font-size: 1.5rem; }
        }
        
        @media (max-width: 480px) {
            h1 { font-size: 1.8rem; letter-spacing: 2px; }
            h2 { font-size: 1.3rem; }
            
            .game-header {
                grid-template-columns: 1fr 1fr;
                padding: 10px;
                gap: 5px;
            }
            
            .game-header div {
                font-size: 0.9rem;
                padding: 8px 5px;
            }
            
            .progress-text {
                font-size: 0.8rem;
            }
            
            .card {
                height: 90px;
            }
            
            .emoji-card { font-size: 2.2rem; }
            .word-card { font-size: 1rem; }
            
            .avatar { font-size: 3.5rem; }
            .color-option { width: 50px; height: 50px; margin: 5px; }
            .player-avatar { font-size: 1.2rem; }
        }
        
        @media (max-width: 360px) {
            h1 { font-size: 1.5rem; letter-spacing: 1px; }
            h2 { font-size: 1.1rem; }
            h3 { font-size: 1rem; }
            .card { height: 80px; }
            .emoji-card { font-size: 2rem; }
            .word-card { font-size: 0.9rem; }
            .mode-btn { min-width: 140px; padding: 12px; font-size: 1rem; }
            .avatar { font-size: 3rem; }
            .color-option { width: 45px; height: 45px; }
            .player-avatar { font-size: 1rem; }
        }
        
        .theme-green { background: radial-gradient(circle at center, #1a3a2a, #0d2a1a); }
        .theme-blue { background: radial-gradient(circle at center, #1a2a3a, #0d1b2a); }
        .theme-red { background: radial-gradient(circle at center, #3a1a1a, #2a0d0d); }
        .theme-purple { background: radial-gradient(circle at center, #3a1a3a, #2a0d2a); }
        .theme-orange { background: radial-gradient(circle at center, #3a2a1a, #2a1a0d); }
        
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="debug-info" id="debug-info">Vocab Loading...</div>
        
        <div id="start-screen" class="screen active">
            <h1>NANDOmode</h1>
            <h2>Learn Spanish Vocabulary</h2>
            
            <div class="username-container">
                <h3>Enter Your Username:</h3>
                <input type="text" id="username-input" placeholder="Type your username..." maxlength="20" aria-label="Enter username">
                <button id="save-username" aria-label="Save username and continue">Save & Continue</button>
            </div>
            
            <div class="avatar-container">
                <div class="avatar" data-avatar="👾" role="button" tabindex="0" aria-label="Select avatar: Alien">👾</div>
                <div class="avatar" data-avatar="🦊" role="button" tabindex="0" aria-label="Select avatar: Fox">🦊</div>
                <div class="avatar selected" data-avatar="🐉" role="button" tabindex="0" aria-label="Select avatar: Dragon">🐉</div>
                <div class="avatar" data-avatar="🦄" role="button" tabindex="0" aria-label="Select avatar: Unicorn">🦄</div>
                <div class="avatar" data-avatar="🤖" role="button" tabindex="0" aria-label="Select avatar: Robot">🤖</div>
                <div class="avatar" data-avatar="👻" role="button" tabindex="0" aria-label="Select avatar: Ghost">👻</div>
                <div class="avatar" data-avatar="🐧" role="button" tabindex="0" aria-label="Select avatar: Penguin">🐧</div>
                <div class="avatar" data-avatar="🦖" role="button" tabindex="0" aria-label="Select avatar: Dinosaur">🦖</div>
            </div>
            
            <div class="color-picker">
                <div class="color-option selected" style="background: #3a7;" data-color="green" role="button" tabindex="0" aria-label="Select green theme"></div>
                <div class="color-option" style="background: #47a;" data-color="blue" role="button" tabindex="0" aria-label="Select blue theme"></div>
                <div class="color-option" style="background: #a54;" data-color="red" role="button" tabindex="0" aria-label="Select red theme"></div>
                <div class="color-option" style="background: #a37;" data-color="purple" role="button" tabindex="0" aria-label="Select purple theme"></div>
                <div class="color-option" style="background: #ea6;" data-color="orange" role="button" tabindex="0" aria-label="Select orange theme"></div>
            </div>
            
            <h3>Select Game Mode:</h3>
            <div class="btn-group">
                <button class="mode-btn easy" data-mode="easy" aria-label="Start easy mode">Easy Mode</button>
                <button class="mode-btn medium" data-mode="medium" aria-label="Start medium mode">Medium Mode</button>
                <button class="mode-btn hard" data-mode="hard" aria-label="Start hard mode">Hard Mode</button>
            </div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="player-info">
                    <span class="player-avatar" id="player-avatar">🐉</span>
                    Player: <span id="player-name">Guest</span>
                </div>
                <div>Score: <span id="score">0</span></div>
                <div>Streak: <span id="streak">0</span></div>
                <div>Progress: <span id="progress">0</span>/100</div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-text"><span id="completed">0</span>/100 (<span id="percent-complete">0</span>%)</div>
                    </div>
                </div>
            </div>
            
            <div class="game-board">
                <div class="column" id="column-left"></div>
                <div class="column" id="column-right"></div>
            </div>
            
            <div class="btn-group">
                <button id="refresh-btn" aria-label="Refresh round">Refresh</button>
                <button id="quit-btn" aria-label="Quit to main menu">Quit</button>
            </div>
        </div>
        
        <div id="round-end-screen" class="screen">
            <h2>Well Done!</h2>
            <div class="round-result">
                Round Score: <span id="round-score">0</span><br>
                Total Score: <span id="total-score">0</span>
            </div>
            <div class="btn-group">
                <button id="continue-btn" aria-label="Continue to leaderboard">Continue</button>
                <button id="quit-round-btn" aria-label="Quit to main menu">Quit</button>
            </div>
        </div>
        
        <div id="leaderboard-screen" class="screen">
            <h2>Leaderboard</h2>
            <div class="leaderboard-container">
                <h3>Your Progress</h3>
                <p>Words Completed: <span id="progress-count">0</span>/100</p>
                <p>Total Score: <span id="progress-score">0</span></p>
                <p>Current Streak: <span id="progress-streak">0</span></p>
                
                <h3>Top Scores</h3>
                <table id="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="btn-group">
                <button id="continue-leader-btn" aria-label="Continue to next round">Continue</button>
                <button id="quit-leader-btn" aria-label="Quit to main menu">Quit</button>
            </div>
        </div>
        
        <div id="game-over-screen" class="screen">
            <h2>Game Complete!</h2>
            <div class="round-result">
                Congratulations <span id="final-player">Player</span>!<br>
                You've mastered 100 Spanish words!<br>
                Final Score: <span id="final-score">0</span>
            </div>
            <div class="leaderboard-container">
                <h3>Hall of Fame</h3>
                <table id="final-leaderboard">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="btn-group">
                <button id="play-again-btn" aria-label="Play again">Play Again</button>
                <button id="main-menu-btn" aria-label="Return to main menu">Main Menu</button>
            </div>
        </div>
    </div>

    <script src="vocab.js"></script>
    
    <script>
        const debugInfo = document.getElementById('debug-info');
        let isProcessingClick = false;
        let lastTTSTime = 0;
        const ttsDebounce = 1000;
        const milestones = [25, 50, 75, 100];
        
        const gameState = {
            currentScreen: 'start',
            player: { name: 'Guest', avatar: '🐉', theme: 'green' },
            mode: '',
            score: 0,
            streak: 0,
            completedWords: 0,
            wordProgress: {},
            currentRound: { 
                pairs: [], 
                leftColumn: [], 
                rightColumn: [], 
                selectedLeft: null, 
                selectedRight: null, 
                matchedPairs: [], 
                roundScore: 0 
            },
            leaderboard: []
        };

        const screens = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            roundEnd: document.getElementById('round-end-screen'),
            leaderboard: document.getElementById('leaderboard-screen'),
            gameOver: document.getElementById('game-over-screen')
        };

        function initGame() {
            if (window.vocab && window.vocab.length > 0) {
                debugInfo.textContent = `Vocab loaded: ${window.vocab.length} words`;
            } else {
                debugInfo.textContent = "Error: vocab.js not loaded!";
                console.error("vocab.js not loaded or empty");
                return;
            }
            
            try {
                const savedLeaderboard = localStorage.getItem('nandomodeLeaderboard');
                if (savedLeaderboard) {
                    gameState.leaderboard = JSON.parse(savedLeaderboard);
                }
            } catch (e) {
                console.warn("Error loading leaderboard:", e);
            }
            
            loadPlayerProgress();
            setupEventListeners();
            updatePlayerUI();
            updateProgressBar();
        }

        function setupEventListeners() {
            document.getElementById('save-username').addEventListener('click', saveUsername);
            
            document.querySelectorAll('.avatar').forEach(avatar => {
                avatar.addEventListener('click', selectAvatar.bind(null, avatar));
                avatar.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') selectAvatar(avatar);
                });
            });

            document.querySelectorAll('.color-option').forEach(color => {
                color.addEventListener('click', selectColor.bind(null, color));
                color.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') selectColor(color);
                });
            });

            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    gameState.mode = btn.dataset.mode;
                    startNewGame();
                });
            });

            document.getElementById('refresh-btn').addEventListener('click', startNewRound);
            document.getElementById('quit-btn').addEventListener('click', quitToMainMenu);
            document.getElementById('continue-btn').addEventListener('click', showLeaderboard);
            document.getElementById('quit-round-btn').addEventListener('click', quitToMainMenu);
            document.getElementById('continue-leader-btn').addEventListener('click', startNewRound);
            document.getElementById('quit-leader-btn').addEventListener('click', quitToMainMenu);
            document.getElementById('play-again-btn').addEventListener('click', startNewGame);
            document.getElementById('main-menu-btn').addEventListener('click', quitToMainMenu);
        }

        function selectAvatar(avatar) {
            document.querySelectorAll('.avatar').forEach(a => a.classList.remove('selected'));
            avatar.classList.add('selected');
            gameState.player.avatar = avatar.dataset.avatar;
            updatePlayerUI();
        }

        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
            color.classList.add('selected');
            gameState.player.theme = color.dataset.color;
        }

        function updatePlayerUI() {
            document.getElementById('player-name').textContent = gameState.player.name;
            document.getElementById('final-player').textContent = gameState.player.name;
            const avatarElement = document.getElementById('player-avatar');
            if (avatarElement) avatarElement.textContent = gameState.player.avatar;
        }

        function saveUsername() {
            const usernameInput = document.getElementById('username-input');
            const username = usernameInput.value.trim();
            
            if (username) {
                const isNewUser = !localStorage.getItem(`nandomodeProgress_${username}`);
                gameState.player.name = username;
                
                if (isNewUser) {
                    gameState.score = 0;
                    gameState.streak = 0;
                    gameState.completedWords = 0;
                    gameState.wordProgress = {};
                    gameState.currentRound = { 
                        pairs: [], 
                        leftColumn: [], 
                        rightColumn: [], 
                        selectedLeft: null, 
                        selectedRight: null, 
                        matchedPairs: [], 
                        roundScore: 0 
                    };
                } else {
                    loadPlayerProgress();
                }
                
                updatePlayerUI();
                savePlayerProgress();
                usernameInput.value = '';
                usernameInput.placeholder = `Welcome, ${username}!`;
                
                const btn = document.getElementById('save-username');
                btn.textContent = isNewUser ? '✓ New User Created!' : '✓ Saved!';
                setTimeout(() => btn.textContent = 'Save & Continue', 1500);
            }
        }

        function savePlayerProgress() {
            try {
                const playerData = {
                    name: gameState.player.name,
                    avatar: gameState.player.avatar,
                    theme: gameState.player.theme,
                    wordProgress: gameState.wordProgress,
                    completedWords: gameState.completedWords,
                    score: gameState.score,
                    streak: gameState.streak
                };
                localStorage.setItem(`nandomodeProgress_${gameState.player.name}`, JSON.stringify(playerData));
                localStorage.setItem('nandomodeCurrentPlayer', gameState.player.name);
            } catch (e) {
                console.warn("Error saving player progress:", e);
            }
        }

        function loadPlayerProgress() {
            try {
                const savedName = localStorage.getItem('nandomodeCurrentPlayer');
                if (savedName && savedName === gameState.player.name) {
                    const savedData = localStorage.getItem(`nandomodeProgress_${savedName}`);
                    if (savedData) {
                        const playerData = JSON.parse(savedData);
                        gameState.player.name = playerData.name || 'Guest';
                        gameState.player.avatar = playerData.avatar || '🐉';
                        gameState.player.theme = playerData.theme || 'green';
                        gameState.wordProgress = playerData.wordProgress || {};
                        gameState.completedWords = playerData.completedWords || 0;
                        gameState.score = playerData.score || 0;
                        gameState.streak = playerData.streak || 0;
                        
                        document.getElementById('username-input').placeholder = `Welcome back, ${gameState.player.name}!`;
                        document.querySelectorAll('.avatar').forEach(avatar => {
                            avatar.classList.toggle('selected', avatar.dataset.avatar === gameState.player.avatar);
                        });
                        document.querySelectorAll('.color-option').forEach(color => {
                            color.classList.toggle('selected', color.dataset.color === gameState.player.theme);
                        });
                        updatePlayerUI();
                        return;
                    }
                }
            } catch (e) {
                console.warn("Error loading player progress:", e);
            }
            gameState.player.name = 'Guest';
            gameState.player.avatar = '🐉';
            gameState.player.theme = 'green';
            gameState.score = 0;
            gameState.streak = 0;
            gameState.completedWords = 0;
            gameState.wordProgress = {};
            updatePlayerUI();
        }

        function startNewGame() {
            document.getElementById('game-container').className = `theme-${gameState.player.theme}`;
            startNewRound();
            savePlayerProgress();
        }

        function startNewRound() {
            generateRoundData();
            updateGameUI();
            showScreen('game');
        }

        function sanitizePairId(word) {
            return word.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Math.random().toString(36).substr(2, 5);
        }

        function generateRoundData() {
            gameState.currentRound = {
                pairs: [],
                leftColumn: [],
                rightColumn: [],
                selectedLeft: null,
                selectedRight: null,
                matchedPairs: [],
                roundScore: 0
            };
            
            const newWords = getNewWords(3);
            const reviewWords = getReviewWords(2);
            const roundWords = shuffleArray([...newWords, ...reviewWords]);
            
            debugInfo.textContent = `Round words: ${roundWords.join(', ')}`;
            
            roundWords.forEach(word => {
                const vocabItem = window.vocab.find(item => item.word === word);
                if (vocabItem) {
                    const pairId = sanitizePairId(word);
                    gameState.currentRound.pairs.push({
                        pairId,
                        word: vocabItem.word,
                        emoji: vocabItem.emoji,
                        type: vocabItem.type
                    });
                }
            });
            
            gameState.currentRound.pairs = shuffleArray([...gameState.currentRound.pairs]);
            
            const emojis = gameState.currentRound.pairs.map(pair => ({
                pairId: pair.pairId,
                type: 'emoji',
                value: pair.emoji
            }));
            const words = gameState.currentRound.pairs.map(pair => ({
                pairId: pair.pairId,
                type: 'word',
                value: pair.word
            }));
            
            const shuffledEmojis = shuffleArray([...emojis]);
            const shuffledWords = shuffleArray([...words]);
            
            if (gameState.mode === 'easy') {
                gameState.currentRound.leftColumn = shuffledEmojis;
                gameState.currentRound.rightColumn = shuffledWords;
            } else {
                gameState.currentRound.leftColumn = shuffledWords;
                gameState.currentRound.rightColumn = shuffledEmojis;
            }
            
            console.log('Generated pairs:', gameState.currentRound.pairs.map(p => `${p.word} (${p.pairId})`));
            console.log('Left Column:', gameState.currentRound.leftColumn.map(item => `${item.value} (${item.pairId})`));
            console.log('Right Column:', gameState.currentRound.rightColumn.map(item => `${item.value} (${item.pairId})`));
        }

        function getNewWords(count) {
            const unseenWords = window.vocab
                .filter(item => !gameState.wordProgress[item.word])
                .map(item => item.word);
            
            if (unseenWords.length < count) {
                const seenWords = Object.keys(gameState.wordProgress).filter(word => gameState.wordProgress[word] < 3);
                const candidates = [...unseenWords, ...seenWords];
                return shuffleArray(candidates).slice(0, count);
            }
            
            return shuffleArray(unseenWords).slice(0, count);
        }

        function getReviewWords(count) {
            const reviewCandidates = Object.keys(gameState.wordProgress)
                .filter(word => gameState.wordProgress[word] > 0 && gameState.wordProgress[word] < 3);
            
            if (reviewCandidates.length < count) {
                return getNewWords(count);
            }
            
            return shuffleArray(reviewCandidates).slice(0, count);
        }

        function updateGameUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('progress').textContent = gameState.completedWords;
            document.getElementById('completed').textContent = gameState.completedWords;
            document.getElementById('percent-complete').textContent = Math.round((gameState.completedWords / 100) * 100);
            updateProgressBar();
            
            const leftColumn = document.getElementById('column-left');
            const rightColumn = document.getElementById('column-right');
            leftColumn.innerHTML = '';
            rightColumn.innerHTML = '';
            
            gameState.currentRound.leftColumn.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `card ${item.type === 'emoji' ? 'emoji-card' : 'word-card'}`;
                card.dataset.pairId = item.pairId;
                card.dataset.type = item.type;
                card.textContent = item.value;
                card.tabIndex = gameState.currentRound.matchedPairs.includes(item.pairId) ? -1 : 0;
                card.setAttribute('role', 'button');
                card.setAttribute('aria-label', `Select card: ${item.value}`);
                if (gameState.currentRound.matchedPairs.includes(item.pairId)) {
                    card.classList.add('matched');
                }
                
                card.addEventListener('click', () => handleCardClick('left', item.pairId, index));
                card.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') handleCardClick('left', item.pairId, index);
                });
                
                leftColumn.appendChild(card);
                console.log(`Rendered left card: pairId=${item.pairId}, type=${item.type}, value=${item.value}, index=${index}`);
            });
            
            gameState.currentRound.rightColumn.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `card ${item.type === 'emoji' ? 'emoji-card' : 'word-card'}`;
                card.dataset.pairId = item.pairId;
                card.dataset.type = item.type;
                card.textContent = item.value;
                card.tabIndex = gameState.currentRound.matchedPairs.includes(item.pairId) ? -1 : 0;
                card.setAttribute('role', 'button');
                card.setAttribute('aria-label', `Select card: ${item.value}`);
                if (gameState.currentRound.matchedPairs.includes(item.pairId)) {
                    card.classList.add('matched');
                }
                
                card.addEventListener('click', () => handleCardClick('right', item.pairId, index));
                card.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') handleCardClick('right', item.pairId, index);
                });
                
                rightColumn.appendChild(card);
                console.log(`Rendered right card: pairId=${item.pairId}, type=${item.type}, value=${item.value}, index=${index}`);
            });
            
            if (gameState.currentRound.matchedPairs.length === 5) {
                console.log('All pairs matched, ending round');
                endRound();
            }
        }

        function updateProgressBar() {
            const progressBar = document.querySelector('.progress-bar');
            const percent = Math.min(100, (gameState.completedWords / 100) * 100);
            progressBar.style.width = `${percent}%`;
        }

        function handleCardClick(column, pairId, index) {
            if (isProcessingClick || gameState.currentRound.matchedPairs.includes(pairId)) {
                console.log(`Skipped click: isProcessing=${isProcessingClick}, pairId=${pairId}, matched=${gameState.currentRound.matchedPairs.includes(pairId)}`);
                return;
            }
            isProcessingClick = true;
            
            const columnData = column === 'left' ? gameState.currentRound.leftColumn : gameState.currentRound.rightColumn;
            const item = columnData[index];
            if (!item || item.pairId !== pairId) {
                console.error(`Item mismatch: pairId=${pairId}, index=${index}, column=${column}, found=${!!item}`);
                isProcessingClick = false;
                return;
            }
            
            const card = document.querySelector(`.card[data-pair-id="${pairId}"][data-type="${item.type}"]`);
            if (!card || card.classList.contains('matched')) {
                console.error(`Invalid card: pairId=${pairId}, type=${item.type}, column=${column}, found=${!!card}`);
                isProcessingClick = false;
                return;
            }
            
            if (gameState.mode !== 'hard' && column === 'left') {
                const pair = gameState.currentRound.pairs.find(p => p.pairId === pairId);
                if (pair && (gameState.mode === 'easy' || gameState.mode === 'medium')) {
                    const now = Date.now();
                    if (now - lastTTSTime >= ttsDebounce) {
                        speakWord(pair.word);
                        lastTTSTime = now;
                        console.log(`TTS triggered: word=${pair.word}`);
                    }
                }
            }
            
            if (column === 'left') {
                if (gameState.currentRound.selectedLeft) {
                    const prevCard = document.querySelector(`.card[data-pair-id="${gameState.currentRound.selectedLeft}"]`);
                    if (prevCard) prevCard.classList.remove('selected');
                }
                gameState.currentRound.selectedLeft = pairId;
                card.classList.add('selected');
            } else {
                if (gameState.currentRound.selectedRight) {
                    const prevCard = document.querySelector(`.card[data-pair-id="${gameState.currentRound.selectedRight}"]`);
                    if (prevCard) prevCard.classList.remove('selected');
                }
                gameState.currentRound.selectedRight = pairId;
                card.classList.add('selected');
            }
            
            console.log(`Selected: left=${gameState.currentRound.selectedLeft}, right=${gameState.currentRound.selectedRight}`);
            
            if (gameState.currentRound.selectedLeft && gameState.currentRound.selectedRight) {
                checkMatch();
            } else {
                isProcessingClick = false;
            }
        }

        function checkMatch() {
            const leftId = gameState.currentRound.selectedLeft;
            const rightId = gameState.currentRound.selectedRight;
            
            console.log(`Checking match: leftId=${leftId}, rightId=${rightId}, matchedPairs=${gameState.currentRound.matchedPairs.length}`);
            
            const leftCard = document.querySelector(`.card[data-pair-id="${leftId}"]`);
            const rightCard = document.querySelector(`.card[data-pair-id="${rightId}"]`);
            
            if (!leftCard || !rightCard) {
                console.error(`Cards not found in checkMatch: leftCard=${leftCard}, rightCard=${rightCard}, leftId=${leftId}, rightId=${rightId}`);
                resetSelections();
                return;
            }
            
            if (leftId === rightId) {
                leftCard.classList.add('correct');
                rightCard.classList.add('correct');
                playSound('correct');
                
                gameState.score++;
                gameState.streak++;
                gameState.currentRound.roundScore++;
                
                const pair = gameState.currentRound.pairs.find(p => p.pairId === leftId);
                if (pair) {
                    gameState.wordProgress[pair.word] = (gameState.wordProgress[pair.word] || 0) + 1;
                    if (gameState.wordProgress[pair.word] === 3) {
                        gameState.completedWords++;
                        checkMilestone();
                    }
                }
                
                gameState.currentRound.matchedPairs.push(leftId);
                console.log(`Match successful, matchedPairs=${gameState.currentRound.matchedPairs.length}`);
                
                if (gameState.streak % 10 === 0) {
                    gameState.score += 5;
                }
                
                setTimeout(() => {
                    leftCard.classList.remove('correct');
                    rightCard.classList.remove('correct');
                    leftCard.classList.add('matched');
                    rightCard.classList.add('matched');
                    leftCard.tabIndex = -1;
                    rightCard.tabIndex = -1;
                    gameState.currentRound.selectedLeft = null;
                    gameState.currentRound.selectedRight = null;
                    isProcessingClick = false;
                    
                    if (gameState.currentRound.matchedPairs.length === 5) {
                        console.log('All pairs matched, ending round');
                        endRound();
                    } else {
                        updateGameUI();
                    }
                }, 500);
            } else {
                leftCard.classList.add('incorrect');
                rightCard.classList.add('incorrect');
                playSound('incorrect');
                
                gameState.score = Math.max(0, gameState.score - 1);
                gameState.streak = 0;
                
                setTimeout(() => {
                    leftCard.classList.remove('selected', 'incorrect');
                    rightCard.classList.remove('selected', 'incorrect');
                    gameState.currentRound.selectedLeft = null;
                    gameState.currentRound.selectedRight = null;
                    isProcessingClick = false;
                    updateGameUI();
                }, 1000);
            }
            
            savePlayerProgress();
        }

        function resetSelections() {
            gameState.currentRound.selectedLeft = null;
            gameState.currentRound.selectedRight = null;
            document.querySelectorAll('.card.selected').forEach(card => card.classList.remove('selected'));
            isProcessingClick = false;
            updateGameUI();
        }

        function checkMilestone() {
            const previousWords = gameState.completedWords - 1;
            const currentWords = gameState.completedWords;
            if (milestones.includes(currentWords) && !milestones.includes(previousWords)) {
                showMilestoneNotification(currentWords);
                createConfetti(document.getElementById('game-screen'), 20);
            }
        }

        function showMilestoneNotification(words) {
            const notification = document.createElement('div');
            notification.className = 'milestone-notification';
            notification.textContent = `Milestone: ${words}/100 Words Mastered!`;
            document.getElementById('game-container').appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function endRound() {
            if (gameState.currentRound.roundScore === 5) {
                gameState.score += gameState.currentRound.roundScore;
            }
            
            document.getElementById('round-score').textContent = gameState.currentRound.roundScore;
            document.getElementById('total-score').textContent = gameState.score;
            savePlayerProgress();
            
            setTimeout(() => {
                createConfetti(document.getElementById('round-end-screen'), 50);
                showScreen('roundEnd');
            }, 1000);
        }

        function showLeaderboard() {
            document.getElementById('progress-count').textContent = gameState.completedWords;
            document.getElementById('progress-score').textContent = gameState.score;
            document.getElementById('progress-streak').textContent = gameState.streak;
            
            const tableBody = document.querySelector('#leaderboard-table tbody');
            tableBody.innerHTML = '';
            
            const topScores = [...gameState.leaderboard].sort((a, b) => b.score - a.score).slice(0, 10);
            
            topScores.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><span class="leaderboard-avatar">${entry.avatar || '🐉'}</span>${entry.name}</td>
                    <td>${entry.score}</td>
                    <td>${new Date(entry.date).toLocaleDateString()}</td>
                `;
                tableBody.appendChild(row);
            });
            
            if (gameState.completedWords >= 100) {
                endGame();
            } else {
                showScreen('leaderboard');
            }
        }

        function endGame() {
            gameState.leaderboard.push({
                name: gameState.player.name,
                avatar: gameState.player.avatar,
                score: gameState.score,
                date: new Date().toISOString()
            });
            
            gameState.leaderboard.sort((a, b) => b.score - a.score);
            gameState.leaderboard = gameState.leaderboard.slice(0, 20);
            
            try {
                localStorage.setItem('nandomodeLeaderboard', JSON.stringify(gameState.leaderboard));
            } catch (e) {
                console.warn("Error saving leaderboard:", e);
            }
            
            document.getElementById('final-score').textContent = gameState.score;
            
            const tableBody = document.querySelector('#final-leaderboard tbody');
            tableBody.innerHTML = '';
            
            const topScores = [...gameState.leaderboard].slice(0, 10);
            
            topScores.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><span class="leaderboard-avatar">${entry.avatar || '🐉'}</span>${entry.name}</td>
                    <td>${entry.score}</td>
                    <td>${new Date(entry.date).toLocaleDateString()}</td>
                `;
                tableBody.appendChild(row);
            });
            
            showScreen('gameOver');
        }

        function quitToMainMenu() {
            showScreen('start');
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
            gameState.currentScreen = screenName;
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function playSound(type) {
            if (!window.AudioContext && !window.webkitAudioContext) {
                console.warn("Web Audio API not supported.");
                return;
            }
            
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                if (context.state === 'suspended') {
                    context.resume().then(() => {
                        createSound(context, type);
                    });
                } else {
                    createSound(context, type);
                }
                console.log(`Playing sound: ${type}`);
            } catch (e) {
                console.warn("Error playing sound:", e);
            }
        }

        function createSound(context, type) {
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);
            
            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, context.currentTime);
                gainNode.gain.setValueAtTime(0.3, context.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1046.50, context.currentTime + 0.2);
                gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.3);
            } else if (type === 'incorrect') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(220, context.currentTime);
                gainNode.gain.setValueAtTime(0.3, context.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(110, context.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.2);
            }
            
            oscillator.start();
            oscillator.stop(context.currentTime + 0.3);
        }

        function createConfetti(container, count) {
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ffbe0b', '#fb5607', '#8338ec'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = `${Math.random() * 2 + 1}s`;
                confetti.style.width = `${Math.random() * 8 + 4}px`;
                confetti.style.height = `${Math.random() * 8 + 4}px`;
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function speakWord(word) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'es-ES';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            } else {
                console.warn("SpeechSynthesis not supported.");
            }
        }

        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
