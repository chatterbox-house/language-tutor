<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NANDOmode - Aprende Vocabulario Espa√±ol</title>
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Aprende vocabulario espa√±ol con divertidos juegos de emparejar">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Comic Neue', cursive, 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            touch-action: manipulation;
        }
        
        #game-container {
            max-width: 900px;
            width: 100%;
            background: rgba(10, 15, 30, 0.85);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            position: relative;
            border: 6px solid #4a4a8a;
        }
        
        .screen {
            display: none;
            padding: 30px 20px;
            min-height: 600px;
        }
        
        .active {
            display: block;
        }
        
        h1, h2, h3 {
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.7);
            font-weight: bold;
            line-height: 1.3;
        }
        
        h1 {
            font-size: 2.8rem;
            margin: 25px 0 15px;
            letter-spacing: 4px;
            color: #f8f8f8;
            text-transform: uppercase;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #ffe66d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
        }
        
        h2 {
            font-size: 2rem;
            margin: 20px 0;
            color: #ffe66d;
        }
        
        h3 {
            font-size: 1.5rem;
            margin: 15px 0;
            color: #4ecdc4;
        }
        
        button {
            background: linear-gradient(145deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 18px 30px;
            font-size: 1.5rem;
            font-family: 'Comic Neue', cursive;
            cursor: pointer;
            margin: 15px;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            border: 3px solid #ff4757;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        button:hover {
            transform: translateY(-4px) scale(1.05);
            background: linear-gradient(145deg, #ff8e8e, #ff6b6b);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        
        .btn-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 25px 0;
        }
        
        .mode-btn {
            min-width: 220px;
            margin: 12px;
            padding: 20px;
            font-size: 1.4rem;
            border-radius: 20px;
        }
        
        .mode-btn.easy { 
            background: linear-gradient(145deg, #3a7, #4bc); 
            border: 3px solid #2aa;
        }
        .mode-btn.medium { 
            background: linear-gradient(145deg, #47a, #58c); 
            border: 3px solid #36b;
        }
        .mode-btn.hard { 
            background: linear-gradient(145deg, #a54, #d66); 
            border: 3px solid #c33;
        }
        
        #start-screen {
            background: radial-gradient(circle at center, #1e3a5f, #132238);
            text-align: center;
        }
        
        .username-container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 3px solid #4ecdc4;
        }
        
        #username-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3rem;
            font-family: inherit;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            margin: 15px 0;
        }
        
        #user-select {
            width: 100%;
            padding: 15px;
            font-size: 1.3rem;
            font-family: inherit;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            margin: 15px 0;
        }
        
        .avatar-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .avatar {
            font-size: 5rem;
            margin: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 3px solid transparent;
            animation: avatarPulse 2s infinite ease-in-out;
        }
        
        .avatar:hover {
            transform: scale(1.15);
            background: rgba(255, 255, 255, 0.1);
            animation: none;
        }
        
        .avatar.selected {
            transform: scale(1.25);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.8);
            border: 3px solid #ffe66d;
            animation: none;
        }
        
        @keyframes avatarPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .color-picker {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .color-option {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 0 12px;
            cursor: pointer;
            border: 3px solid #555;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            transform: scale(1.25);
            border: 4px solid white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        
        #game-screen {
            background: radial-gradient(circle at center, #1a2a3a, #0d1b2a);
        }
        
        .game-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 3px solid #4a4a8a;
        }
        
        .game-header div {
            font-size: 1.2rem;
            text-align: center;
            padding: 10px 5px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            border: 2px solid #4ecdc4;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .player-avatar {
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .game-header .progress-container {
            grid-column: 1 / span 2;
            width: 100%;
            margin: 10px 0 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            height: 30px;
            border: 2px solid #4a4a8a;
            overflow: hidden;
            padding: 0;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        /* Simplified Progress Tracker */
        .progress-tracker {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #4ecdc4;
            font-size: 0.9rem;
            text-align: center;
            z-index: 100;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .progress-tracker-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        
        .progress-tracker-label {
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .progress-tracker-value {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .game-board {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            min-height: 400px;
            gap: 10px;
        }
        
        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 45%;
        }
        
        .card {
            background: rgba(30, 40, 70, 0.8);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 140px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            border: 3px solid rgba(100, 100, 200, 0.3);
        }
        
        .card:hover {
            transform: translateY(-5px);
            background: rgba(40, 50, 90, 0.9);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            border-color: rgba(100, 200, 255, 0.5);
        }
        
        .card.selected {
            background: rgba(100, 200, 255, 0.3);
            box-shadow: 0 0 20px rgba(100, 200, 255, 0.6);
            border: 3px solid rgba(100, 200, 255, 0.7);
        }
        
        .card.correct {
            background: rgba(100, 255, 100, 0.3);
            animation: pulse 0.5s ease;
        }
        
        .card.incorrect {
            background: rgba(255, 100, 100, 0.3);
            animation: shake 0.5s ease;
        }
        
        .card.matched {
            background: rgba(100, 255, 100, 0.5);
            border: 3px solid #4ecdc4;
            box-shadow: 0 0 15px rgba(100, 255, 100, 0.8);
            pointer-events: none;
            cursor: default;
        }
        
        .emoji-card {
            font-size: 4rem;
        }
        
        .word-card {
            font-size: 1.8rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 15px;
        }
        
        #round-complete-screen {
            background: radial-gradient(circle at center, #2a3a2a, #1a2a1a);
            text-align: center;
        }
        
        .round-result {
            font-size: 1.8rem;
            margin: 30px 0;
            padding: 25px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: 3px solid #4ecdc4;
            max-width: 600px;
            margin: 30px auto;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: fall 2s linear forwards;
        }
        
        #trophy-room-screen {
            background: radial-gradient(circle at center, #2a2a3a, #1a1a2a);
            text-align: center;
        }
        
        .trophy-container {
            max-width: 700px;
            margin: 20px auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            border: 3px solid #4ecdc4;
        }
        
        .trophy-item {
            font-size: 3rem;
            margin: 15px;
            display: inline-block;
            animation: trophySpin 2s infinite linear;
        }
        
        #game-over-screen {
            background: radial-gradient(circle at center, #3a2a2a, #2a1a1a);
            text-align: center;
        }
        
        .milestone-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #ffe66d;
            padding: 15px 30px;
            border-radius: 10px;
            border: 3px solid #4ecdc4;
            font-size: 1.2rem;
            z-index: 1000;
            animation: fadeInOut 3s ease forwards;
        }
        
        .error-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 100, 100, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            border: 3px solid #ff4757;
            font-size: 1.2rem;
            z-index: 1000;
            animation: fadeInOut 3s ease forwards;
        }

        .success-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(100, 255, 100, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            border: 3px solid #4ecdc4;
            font-size: 1.2rem;
            z-index: 1000;
            animation: fadeInOut 3s ease forwards;
        }

        .translation-display {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1rem;
            text-align: center;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
            animation: fadeInOut 3s ease forwards;
            pointer-events: none;
            border: 2px solid #4ecdc4;
        }

        .translation-display span {
            display: block;
        }

        .translation-display .word {
            font-weight: bold;
            color: #ffe66d;
        }

        .translation-display .translation {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .reward-path {
            display: flex;
            justify-content: space-between;
            margin: 20px auto;
            max-width: 500px;
        }
        
        .reward-step {
            text-align: center;
            opacity: 0.5;
            transition: all 0.3s;
            font-size: 2rem;
        }
        
        .reward-step.earned {
            opacity: 1;
            transform: scale(1.1);
            filter: drop-shadow(0 0 5px gold);
        }
        
        .reward-step.next {
            opacity: 0.8;
            text-shadow: 0 0 10px #ffe66d;
        }
        
        .reward-label {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .word-mastery-1 { border-color: #4ecdc4 !important; }
        .word-mastery-2 { border-color: silver !important; }
        .word-mastery-3 { border-color: gold !important; animation: pulse 1s infinite; }
        
        .logout-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 100, 100, 0.7);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid #ff4757;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background: rgba(255, 100, 100, 0.9);
            transform: translateY(-2px);
        }
        
        /* Bonus Game Popup */
        .bonus-game-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .bonus-game-content {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #ffe66d;
            max-width: 80%;
            text-align: center;
        }

        .bonus-game-content h3 {
            color: #ffe66d;
            margin-bottom: 15px;
        }

        .bonus-game-content p {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .bonus-game-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .bonus-game-buttons button {
            padding: 12px 24px;
            font-size: 1.2rem;
        }

        /* Fruit Machine Styles */
        .fruit-machine {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .fruit-reel {
            width: 80px;
            height: 80px;
            font-size: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 2px solid #4ecdc4;
            overflow: hidden;
        }

        .fruit-reel-inner {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Balloon Game Styles */
        .balloon-game {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .balloon {
            width: 60px;
            height: 80px;
            background: #ff6b6b;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            position: relative;
            animation: float 3s infinite ease-in-out;
        }

        .balloon:after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 50%;
            width: 2px;
            height: 15px;
            background: #ccc;
        }

.bonus-game-content {
    position: relative;
    min-height: 300px;
}

#close-bonus-btn {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid #ff6b6b;
}

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Animations */
        @keyframes fadeInOut {
            0% { opacity: 0.3; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1.1); }
        }
        
        @keyframes fall {
            to { transform: translateY(400px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(100, 255, 100, 0.6); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(100, 255, 100, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(100, 255, 100, 0.6); }
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-15px); }
            50% { transform: translateX(15px); }
            75% { transform: translateX(-15px); }
            100% { transform: translateX(0); }
        }
        
        @keyframes trophySpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile Scaling */
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            h2 { font-size: 1.6rem; }
            h3 { font-size: 1.2rem; }
            
            .game-header {
                grid-template-columns: 1fr 1fr;
            }
            
            .game-header div:nth-child(1), .game-header div:nth-child(2) {
                grid-column: 1 / span 2;
            }
            
            .game-header .progress-container {
                grid-column: 1 / span 2;
            }
            
            .game-board {
                flex-direction: row;
                gap: 10px;
            }
            
            .column {
                flex: 1;
                min-width: 45%;
            }
            
            .card {
                height: 120px;
                padding: 15px;
            }
            
            .emoji-card { font-size: 2.8rem; }
            .word-card { font-size: 1.4rem; }
            
            button { padding: 12px 20px; font-size: 1.1rem; }
            .mode-btn { min-width: 160px; padding: 15px; }
            
            .avatar { font-size: 4rem; margin: 8px; }
            .player-avatar { font-size: 1.5rem; }
            
            .logout-btn {
                position: static;
                margin: 10px auto;
                width: 90%;
            }
            
            .progress-tracker {
                position: static;
                margin: 10px auto;
                width: 90%;
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            h1 { font-size: 1.8rem; letter-spacing: 2px; }
            h2 { font-size: 1.3rem; }
            
            .game-header {
                grid-template-columns: 1fr 1fr;
                padding: 10px;
                gap: 5px;
            }
            
            .game-header div {
                font-size: 1rem;
                padding: 8px 5px;
            }
            
            .progress-text {
                font-size: 1rem;
            }
            
            .card {
                height: 120px;
                padding: 15px;
            }
            
            .emoji-card { font-size: 2.5rem; }
            .word-card { font-size: 1.2rem; }
            
            .avatar { font-size: 3.5rem; }
            .color-option { width: 50px; height: 50px; margin: 5px; }
            .player-avatar { font-size: 1.2rem; }
            
            .reward-path {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .reward-step {
                margin: 5px;
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 360px) {
            h1 { font-size: 1.5rem; letter-spacing: 1px; }
            h2 { font-size: 1.1rem; }
            h3 { font-size: 1rem; }
            .card { height: 120px; }
            .emoji-card { font-size: 2.2rem; }
            .word-card { font-size: 1.1rem; }
            .mode-btn { min-width: 140px; padding: 12px; font-size: 1rem; }
            .avatar { font-size: 3rem; }
            .color-option { width: 45px; height: 45px; }
            .player-avatar { font-size: 1rem; }
        }
        
        .theme-green { background: radial-gradient(circle at center, #1a3a2a, #0d2a1a); }
        .theme-blue { background: radial-gradient(circle at center, #1a2a3a, #0d1b2a); }
        .theme-red { background: radial-gradient(circle at center, #3a1a1a, #2a0d0d); }
        .theme-purple { background: radial-gradient(circle at center, #3a1a3a, #2a0d2a); }
        .theme-orange { background: radial-gradient(circle at center, #3a2a1a, #2a1a0d); }
        
        /* Language Toggle Button */
        .language-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 1000;
        }

        .language-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
<div id="game-container">
    <!-- Language toggle button -->
    <button id="language-toggle" class="language-toggle">üåê English</button>
    
    <div id="error-notification" class="error-notification" style="display: none;"></div>
    <div id="success-notification" class="success-notification" style="display: none;"></div>
    <div id="translation-display" class="translation-display" style="display: none;"></div>
        
    <button id="logout-btn" class="logout-btn" style="display: none;">üö™ Cerrar Sesi√≥n</button>
        
    <!-- Simplified Progress Tracker -->
    <div class="progress-tracker">
        <div class="progress-tracker-item">
            <div class="progress-tracker-label">Palabras Dominadas</div>
            <div class="progress-tracker-value"><span id="mastered-words">0</span>/<span id="total-words">0</span></div>
        </div>
        <div class="progress-tracker-item" id="medals-tracker" style="display: none;">
            <div class="progress-tracker-label">Medallas</div>
            <div class="progress-tracker-value"><span id="medals-count">0</span></div>
        </div>
        <div class="progress-tracker-item" id="trophies-tracker" style="display: none;">
            <div class="progress-tracker-label">Trofeos</div>
            <div class="progress-tracker-value"><span id="trophies-count">0</span></div>
        </div>
    </div>
        
    <div id="start-screen" class="screen active">
        <h1>NANDOmode</h1>
        <h2>Aprende Vocabulario Espa√±ol</h2>
        
        <div class="username-container">
            <h3>Selecciona o Introduce Nombre:</h3>
            <select id="user-select" aria-label="Seleccionar usuario existente">
                <option value="">Nuevo Usuario</option>
            </select>
            <input type="text" id="username-input" placeholder="Escribe nuevo nombre..." maxlength="20" aria-label="Introducir nuevo nombre">
            <button id="save-username" aria-label="Guardar nombre y continuar">üíæ Guardar & Continuar</button>
        </div>
        
        <div class="avatar-container">
            <div class="avatar" data-avatar="üëæ" role="button" tabindex="0" aria-label="Seleccionar avatar: Alien">üëæ</div>
            <div class="avatar" data-avatar="ü¶ä" role="button" tabindex="0" aria-label="Seleccionar avatar: Zorro">ü¶ä</div>
            <div class="avatar selected" data-avatar="üêâ" role="button" tabindex="0" aria-label="Seleccionar avatar: Drag√≥n">üêâ</div>
            <div class="avatar" data-avatar="ü¶Ñ" role="button" tabindex="0" aria-label="Seleccionar avatar: Unicornio">ü¶Ñ</div>
        </div>
        
        <div class="color-picker">
            <div class="color-option selected" style="background: #3a7;" data-color="green" role="button" tabindex="0" aria-label="Seleccionar tema verde"></div>
            <div class="color-option" style="background: #47a;" data-color="blue" role="button" tabindex="0" aria-label="Seleccionar tema azul"></div>
            <div class="color-option" style="background: #a54;" data-color="red" role="button" tabindex="0" aria-label="Seleccionar tema rojo"></div>
        </div>
        
        <div class="btn-group">
            <button id="quick-play-btn" aria-label="Juego r√°pido como invitado">üéÆ Juego R√°pido</button>
        </div>
        
        <h3>Selecciona Modo de Juego:</h3>
        <div class="btn-group">
            <button class="mode-btn easy" data-mode="easy" aria-label="Iniciar modo f√°cil">üòä Modo F√°cil</button>
            <button class="mode-btn medium" data-mode="medium" aria-label="Iniciar modo medio">üòÉ Modo Medio</button>
            <button class="mode-btn hard" data-mode="hard" aria-label="Iniciar modo dif√≠cil">ü§ì Modo Dif√≠cil (2x puntos)</button>
        </div>
    </div>
    
    <div id="game-screen" class="screen">
        <div class="game-header">
            <div class="player-info">
                <span class="player-avatar" id="player-avatar">üêâ</span>
                Jugador: <span id="player-name">Invitado</span>
            </div>
            <div>Puntos: <span id="score">0</span></div>
            <div>Racha: <span id="streak">0</span></div>
            <div>Progreso: <span id="progress">0</span>/50</div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-text"><span id="percent-complete">0</span>%</div>
                </div>
            </div>
        </div>
        
        <div class="game-board" id="game-board">
            <!-- Dynamic content based on game mode -->
        </div>
        
        <div class="btn-group">
            <button id="quit-btn" aria-label="Salir al men√∫ principal">üè† Salir</button>
        </div>
    </div>
    
    <div id="round-complete-screen" class="screen">
        <h2>¬°Bien Hecho!</h2>
        <div class="round-result" role="alert">
            Puntos de Ronda: <span id="round-score">0</span><br>
            Puntos Totales: <span id="total-score">0</span><br>
            Palabras Dominadas: <span id="progress-count">0</span>/50<br>
            Racha Actual: <span id="progress-streak">0</span>
        </div>
        <div class="trophy-container">
            <h3>Tus Recompensas</h3>
            <div id="trophy-display"></div>
            <div class="reward-path" id="reward-path-display">
                <div class="reward-step" data-step="medal">
                    üéñÔ∏è
                    <div class="reward-label">Medalla</div>
                </div>
                <div class="reward-step" data-step="trophy">
                    üèÜ
                    <div class="reward-label">Trofeo</div>
                </div>
            </div>
        </div>
        <div class="btn-group">
            <button id="next-round-btn" aria-label="Continuar a siguiente ronda">‚è≠Ô∏è Siguiente Ronda</button>
            <button id="quit-round-btn" aria-label="Salir al men√∫ principal">üè† Salir</button>
        </div>
    </div>
    
    <div id="trophy-room-screen" class="screen">
        <h2>Sala de Trofeos</h2>
        <div class="trophy-container">
            <h3>Tus Logros</h3>
            <div id="trophy-list"></div>
        </div>
        <div class="btn-group">
            <button id="back-to-menu-btn" aria-label="Volver al men√∫ principal">üè† Men√∫ Principal</button>
        </div>
    </div>
    
    <div id="game-over-screen" class="screen">
        <h2>¬°Felicidades!</h2>
        <div class="round-result" role="alert">
            ¬°Enhorabuena <span id="final-player">Jugador</span>!<br>
            ¬°Has dominado 50 palabras en espa√±ol!<br>
            Puntos Finales: <span id="final-score">0</span>
        </div>
        <div class="trophy-container">
            <h3>Tus Recompensas</h3>
            <div id="final-trophy-display"></div>
        </div>
        <div class="btn-group">
            <button id="play-again-btn" aria-label="Jugar de nuevo">üîÑ Jugar Otra Vez</button>
            <button id="main-menu-btn" aria-label="Volver al men√∫ principal">üè† Men√∫ Principal</button>
        </div>
    </div>
    
    <!-- Bonus Game Popup (hidden by default) -->
    <div id="bonus-game-popup" class="bonus-game-popup" style="display: none;">
        <div class="bonus-game-content">
            <h3>¬°Bonus Game Desbloqueado!</h3>
            <p>¬°Has completado 15 emparejamientos! Juega un minijuego para ganar puntos extra.</p>
            <div class="fruit-machine" id="fruit-machine">
                <div class="fruit-reel">
                    <div class="fruit-reel-inner" id="fruit-reel-1">üçé</div>
                </div>
                <div class="fruit-reel">
                    <div class="fruit-reel-inner" id="fruit-reel-2">üçä</div>
                </div>
                <div class="fruit-reel">
                    <div class="fruit-reel-inner" id="fruit-reel-3">üçã</div>
                </div>
            </div>
            <div class="balloon-game" id="balloon-game" style="display: none;">
                <!-- Balloons will be added dynamically -->
            </div>
            <div class="bonus-game-buttons">
                <button id="play-bonus-game-btn" aria-label="Jugar juego bonus ahora">üéÆ Jugar Ahora</button>
                <button id="save-bonus-game-btn" aria-label="Guardar juego bonus para despu√©s">üíæ Guardar para Despu√©s</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== LANGUAGE SUPPORT =====
const translations = {
    es: {
        appName: "NANDOmode",
        subtitle: "Aprende Vocabulario Espa√±ol",
        selectUser: "Selecciona o Introduce Nombre:",
        newUser: "Nuevo Usuario",
        usernamePlaceholder: "Escribe nuevo nombre...",
        saveContinue: "üíæ Guardar & Continuar",
        selectMode: "Selecciona Modo de Juego:",
        easyMode: "üòä Modo F√°cil",
        mediumMode: "üòÉ Modo Medio",
        hardMode: "ü§ì Modo Dif√≠cil (2x puntos)",
        quickPlay: "üéÆ Juego R√°pido",
        logout: "üö™ Cerrar Sesi√≥n",
        quit: "üè† Salir",
        nextRound: "‚è≠Ô∏è Siguiente Ronda",
        playAgain: "üîÑ Jugar Otra Vez",
        mainMenu: "üè† Men√∫ Principal",
        masteredWords: "Palabras Dominadas",
        medals: "Medallas",
        trophies: "Trofeos",
        player: "Jugador",
        score: "Puntos",
        streak: "Racha",
        progress: "Progreso",
        roundComplete: "¬°Bien Hecho!",
        roundScore: "Puntos de Ronda",
        totalScore: "Puntos Totales",
        progressCount: "Palabras Dominadas",
        progressStreak: "Racha Actual",
        yourRewards: "Tus Recompensas",
        medalLabel: "Medalla",
        trophyLabel: "Trofeo",
        achievements: "Tus Logros",
        gameOver: "¬°Felicidades!",
        finalPlayer: "¬°Enhorabuena",
        finalScore: "Puntos Finales",
        bonusGameTitle: "¬°Bonus Game Desbloqueado!",
        bonusGameText: "¬°Has completado 15 emparejamientos! Juega un minijuego para ganar puntos extra.",
        playNow: "üéÆ Jugar Ahora",
        saveForLater: "üíæ Guardar para Despu√©s"
    },
    en: {
        appName: "NANDOmode",
        subtitle: "Learn Spanish Vocabulary",
        selectUser: "Select or Enter Name:",
        newUser: "New User",
        usernamePlaceholder: "Enter new name...",
        saveContinue: "üíæ Save & Continue",
        selectMode: "Select Game Mode:",
        easyMode: "üòä Easy Mode",
        mediumMode: "üòÉ Medium Mode",
        hardMode: "ü§ì Hard Mode (2x points)",
        quickPlay: "üéÆ Quick Play",
        logout: "üö™ Log Out",
        quit: "üè† Quit",
        nextRound: "‚è≠Ô∏è Next Round",
        playAgain: "üîÑ Play Again",
        mainMenu: "üè† Main Menu",
        masteredWords: "Mastered Words",
        medals: "Medals",
        trophies: "Trophies",
        player: "Player",
        score: "Score",
        streak: "Streak",
        progress: "Progress",
        roundComplete: "Great Job!",
        roundScore: "Round Score",
        totalScore: "Total Score",
        progressCount: "Words Mastered",
        progressStreak: "Current Streak",
        yourRewards: "Your Rewards",
        medalLabel: "Medal",
        trophyLabel: "Trophy",
        achievements: "Your Achievements",
        gameOver: "Congratulations!",
        finalPlayer: "Congratulations",
        finalScore: "Final Score",
        bonusGameTitle: "Bonus Game Unlocked!",
        bonusGameText: "You've completed 15 matches! Play a minigame to earn extra points.",
        playNow: "üéÆ Play Now",
        saveForLater: "üíæ Save for Later"
    }
};

let currentLanguage = 'es'; // Default to Spanish

// Function to update all text elements
function updateLanguage() {
    const lang = translations[currentLanguage];
    
    // Update UI elements
    const languageToggle = document.getElementById('language-toggle');
    if (languageToggle) languageToggle.textContent = currentLanguage === 'es' ? 'üåê English' : 'üåê Espa√±ol';
    
    const h1 = document.querySelector('h1');
    if (h1) h1.textContent = lang.appName;
    
    const h2 = document.querySelector('h2');
    if (h2) h2.textContent = lang.subtitle;
    
    const usernameContainerH3 = document.querySelector('.username-container h3');
    if (usernameContainerH3) usernameContainerH3.textContent = lang.selectUser;
    
    const userSelectOption = document.querySelector('#user-select option[value=""]');
    if (userSelectOption) userSelectOption.textContent = lang.newUser;
    
    const usernameInput = document.getElementById('username-input');
    if (usernameInput) usernameInput.placeholder = lang.usernamePlaceholder;
    
    const saveUsername = document.getElementById('save-username');
    if (saveUsername) saveUsername.textContent = lang.saveContinue;
    
    const modeSelectH3 = document.querySelector('#start-screen h3:nth-of-type(2)');
    if (modeSelectH3) modeSelectH3.textContent = lang.selectMode;
    
    const easyModeBtn = document.querySelector('.mode-btn.easy');
    if (easyModeBtn) easyModeBtn.textContent = lang.easyMode;
    
    const mediumModeBtn = document.querySelector('.mode-btn.medium');
    if (mediumModeBtn) mediumModeBtn.textContent = lang.mediumMode;
    
    const hardModeBtn = document.querySelector('.mode-btn.hard');
    if (hardModeBtn) hardModeBtn.textContent = lang.hardMode;
    
    const quickPlayBtn = document.getElementById('quick-play-btn');
    if (quickPlayBtn) quickPlayBtn.textContent = lang.quickPlay;
    
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) logoutBtn.textContent = lang.logout;
    
    const quitBtn = document.getElementById('quit-btn');
    if (quitBtn) quitBtn.textContent = lang.quit;
    
    const nextRoundBtn = document.getElementById('next-round-btn');
    if (nextRoundBtn) nextRoundBtn.textContent = lang.nextRound;
    
    const quitRoundBtn = document.getElementById('quit-round-btn');
    if (quitRoundBtn) quitRoundBtn.textContent = lang.quit;
    
    const playAgainBtn = document.getElementById('play-again-btn');
    if (playAgainBtn) playAgainBtn.textContent = lang.playAgain;
    
    const mainMenuBtn = document.getElementById('main-menu-btn');
    if (mainMenuBtn) mainMenuBtn.textContent = lang.mainMenu;
    
    // Update progress tracker labels if they exist
    const progressTrackerItems = document.querySelectorAll('.progress-tracker-item');
    if (progressTrackerItems.length > 0) {
        const labels = [
            lang.masteredWords,
            lang.medals,
            lang.trophies
        ];
        
        progressTrackerItems.forEach((item, index) => {
            const label = item.querySelector('.progress-tracker-label');
            if (label && labels[index]) {
                label.textContent = labels[index];
            }
        });
    }
    
    // Update game header if it exists
    const gameHeader = document.querySelector('.game-header');
    if (gameHeader) {
        const playerInfo = gameHeader.querySelector('div:nth-child(1)');
        if (playerInfo) {
            playerInfo.innerHTML = `<span class="player-avatar" id="player-avatar">${gameState.player.avatar}</span> ${lang.player}: <span id="player-name">${gameState.player.name}</span>`;
        }
        
        const scoreDiv = gameHeader.querySelector('div:nth-child(2)');
        if (scoreDiv) scoreDiv.textContent = `${lang.score}: `;
        
        const streakDiv = gameHeader.querySelector('div:nth-child(3)');
        if (streakDiv) streakDiv.textContent = `${lang.streak}: `;
        
        const progressDiv = gameHeader.querySelector('div:nth-child(4)');
        if (progressDiv) progressDiv.textContent = `${lang.progress}: `;
    }
    
    // Update round complete screen if it exists
    const roundCompleteH2 = document.querySelector('#round-complete-screen h2');
    if (roundCompleteH2) roundCompleteH2.textContent = lang.roundComplete;
    
    const trophyContainerH3 = document.querySelector('.trophy-container h3');
    if (trophyContainerH3) trophyContainerH3.textContent = lang.yourRewards;
    
    const rewardLabels = document.querySelectorAll('.reward-label');
    if (rewardLabels.length > 0) {
        rewardLabels[0].textContent = lang.medalLabel;
        rewardLabels[1].textContent = lang.trophyLabel;
    }
    
    // Update trophy room screen if it exists
    const trophyRoomH2 = document.querySelector('#trophy-room-screen h2');
    if (trophyRoomH2) trophyRoomH2.textContent = lang.trophyRoom;
    
    const trophyRoomH3 = document.querySelector('#trophy-room-screen .trophy-container h3');
    if (trophyRoomH3) trophyRoomH3.textContent = lang.achievements;
    
    // Update game over screen if it exists
    const gameOverH2 = document.querySelector('#game-over-screen h2');
    if (gameOverH2) gameOverH2.textContent = lang.gameOver;
    
    // Update bonus game popup if it exists
    const bonusGameH3 = document.querySelector('#bonus-game-popup h3');
    if (bonusGameH3) bonusGameH3.textContent = lang.bonusGameTitle;
    
    const bonusGameP = document.querySelector('#bonus-game-popup p');
    if (bonusGameP) bonusGameP.textContent = lang.bonusGameText;
    
    const playBonusBtn = document.getElementById('play-bonus-game-btn');
    if (playBonusBtn) playBonusBtn.textContent = lang.playNow;
    
    const saveBonusBtn = document.getElementById('save-bonus-game-btn');
    if (saveBonusBtn) saveBonusBtn.textContent = lang.saveForLater;
    
    // Update dynamic text elements
    updatePlayerUI();
    updateProgressTracker();
}

// Game state variables
const isMobile = window.innerWidth <= 768;
let isProcessingClick = false;
let lastTTSTime = 0;
const ttsDebounce = 1000;
let totalWords = 0;
let milestones = [];
let roundsPlayed = 0;
let matchesCompleted = 0; // Track matches for bonus games
let matchesInRound = 0; // Track matches in current 5-match round
let perfectRound = true; // Track if all matches in round were correct
let bonusGameAvailable = false;

// Sound effects
function playSound(type) {
    if (typeof Audio === 'undefined') return;
    
    const sounds = {
        correct: 'https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3',
        incorrect: 'https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3',
        spin: 'https://assets.mixkit.co/sfx/preview/mixkit-slot-machine-spin-1930.mp3',
        win: 'https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3',
        flamenco: 'https://assets.mixkit.co/sfx/preview/mixkit-flamenco-guitar-stroke-1255.mp3',
        pop: 'https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3'
    };
    
    if (sounds[type]) {
        const audio = new Audio(sounds[type]);
        audio.volume = 0.3; // Lower volume to be less intrusive
        audio.play().catch(e => console.log("Audio play failed:", e));
    }
}
// Main game state
const gameState = {
    currentScreen: 'start',
    player: {
        name: 'Invitado',
        avatar: 'üêâ',
        theme: 'green',
        emoji: '',
        points: 0,
        rewards: { 
            medals: 0,
            trophies: 0,
            totalWordsMastered: 0
        },
        unlockedStickers: [],
        bonusGamesAvailable: 0
    },
    mode: '',
    streak: 0,
    completedWords: 0,
    wordProgress: {},
    currentRound: { 
        pairs: [], 
        leftColumn: [], 
        rightColumn: [], 
        selectedLeft: null, 
        selectedRight: null, 
        matchedPairs: [], 
        roundPoints: 0 
    },
    leaderboard: []
};

function showSuccess(message) {
    const notification = document.getElementById('success-notification');
    notification.textContent = message;
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function showError(message) {
    const notification = document.getElementById('error-notification');
    notification.textContent = message;
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'milestone-notification';
    notification.textContent = message;
    document.getElementById('game-container').appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Screen elements
const screens = {
    start: document.getElementById('start-screen'),
    game: document.getElementById('game-screen'),
    roundComplete: document.getElementById('round-complete-screen'),
    trophyRoom: document.getElementById('trophy-room-screen'),
    gameOver: document.getElementById('game-over-screen')
};

// Initialize the game
window.addEventListener('DOMContentLoaded', () => {
    initGame();
});

function initGame() {
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
    } catch (e) {
        console.error("LocalStorage not available:", e);
        showError("La configuraci√≥n de tu navegador impide guardar el progreso. Por favor, habilita localStorage.");
        return;
    }
    
loadVocab().then(vocab => {
    if (!vocab || vocab.length === 0) {
        console.warn("vocab.js not loaded, using default vocab");
        vocab = [
            { word: "hola", emoji: "üëã", en: "hello", jp: "„Åì„Çì„Å´„Å°„ÅØ", type: "greeting" },
            { word: "adi√≥s", emoji: "üëã", en: "goodbye", jp: "„Åï„Çà„ÅÜ„Å™„Çâ", type: "greeting" },
            { word: "gracias", emoji: "üôè", en: "thank you", jp: "„ÅÇ„Çä„Åå„Å®„ÅÜ", type: "expression" },
            { word: "por favor", emoji: "üôè", en: "please", jp: "„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", type: "expression" },
            { word: "s√≠", emoji: "üëç", en: "yes", jp: "„ÅØ„ÅÑ", type: "response" },
            { word: "no", emoji: "üëé", en: "no", jp: "„ÅÑ„ÅÑ„Åà", type: "response" },
            { word: "perro", emoji: "üêï", en: "dog", jp: "Áä¨", type: "animal" },
            { word: "gato", emoji: "üêà", en: "cat", jp: "Áå´", type: "animal" },
            { word: "casa", emoji: "üè†", en: "house", jp: "ÂÆ∂", type: "place" },
            { word: "comida", emoji: "üç≤", en: "food", jp: "È£ü„ÅπÁâ©", type: "thing" }
        ];
    }
        
        totalWords = vocab.length;
        document.getElementById('total-words').textContent = totalWords;
        
        // Create milestones every 50 words
        milestones = [];
        for (let i = 50; i <= totalWords; i += 50) {
            milestones.push(i);
        }
        
        // Also add some early milestones for motivation
        if (!milestones.includes(5)) milestones.push(5);
        if (!milestones.includes(10)) milestones.push(10);
        if (!milestones.includes(25)) milestones.push(25);
        milestones.sort((a, b) => a - b);
        
        try {
            const savedLeaderboard = localStorage.getItem('nandomodeLeaderboard');
            if (savedLeaderboard) {
                gameState.leaderboard = JSON.parse(savedLeaderboard);
            }
        } catch (e) {
            console.warn("Error loading leaderboard:", e);
            showError("No se pudo cargar el marcador. ¬°Empezando de nuevo!");
        }
        
        populateUserSelect();
        loadPlayerProgress();
        setupEventListeners();
        updatePlayerUI();
        updateProgressBar();
        updateRewardPath();
        updateLogoutButton();
        updateProgressTracker();
    });
    updateLanguage(); // Set initial language
}

function updateProgressTracker() {
    document.getElementById('mastered-words').textContent = gameState.player.rewards.totalWordsMastered;
    document.getElementById('total-words').textContent = totalWords;
    
    // Only show medals/trophies if earned
    const medalsTracker = document.getElementById('medals-tracker');
    const trophiesTracker = document.getElementById('trophies-tracker');
    
    if (gameState.player.rewards.medals > 0) {
        document.getElementById('medals-count').textContent = gameState.player.rewards.medals;
        medalsTracker.style.display = 'flex';
    } else {
        medalsTracker.style.display = 'none';
    }
    
    if (gameState.player.rewards.trophies > 0) {
        document.getElementById('trophies-count').textContent = gameState.player.rewards.trophies;
        trophiesTracker.style.display = 'flex';
    } else {
        trophiesTracker.style.display = 'none';
    }
}

function loadVocab() {
    return new Promise((resolve) => {
        // Check if vocab.js is loaded
        if (window.vocab && Array.isArray(window.vocab)) {
            resolve(window.vocab);
        } else {
            // Try to load vocab.js
            const script = document.createElement('script');
            script.src = 'vocab.js';
            script.onload = () => {
                resolve(window.vocab || defaultVocab);
            };
            script.onerror = () => {
                console.warn("Failed to load vocab.js");
                resolve(defaultVocab);
            };
            document.head.appendChild(script);
        }
    });
}

function populateUserSelect() {
    const userSelect = document.getElementById('user-select');
    userSelect.innerHTML = '<option value="">Nuevo Usuario</option>';
    
    const keys = Object.keys(localStorage);
    const users = [];
    keys.forEach(key => {
        if (key.startsWith('nandomodeProgress_')) {
            const username = key.replace('nandomodeProgress_', '');
            users.push(username);
        }
    });
    
    users.sort();
    
    users.forEach(username => {
        const option = document.createElement('option');
        option.value = username;
        option.textContent = username;
        userSelect.appendChild(option);
    });
    
    const savedName = localStorage.getItem('nandomodeCurrentPlayer');
    if (savedName && users.includes(savedName)) {
        userSelect.value = savedName;
        loadSelectedUser();
    }
}

function setupEventListeners() {
    document.getElementById('save-username').addEventListener('click', saveUsername);
    document.getElementById('user-select').addEventListener('change', loadSelectedUser);
    document.getElementById('quick-play-btn').addEventListener('click', quickPlay);
    document.getElementById('back-to-menu-btn').addEventListener('click', quitToMainMenu);
    document.getElementById('logout-btn').addEventListener('click', logout);
    
    document.querySelectorAll('.avatar').forEach(avatar => {
        avatar.addEventListener('click', selectAvatar.bind(null, avatar));
        avatar.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') selectAvatar(avatar);
        });
    });

    document.querySelectorAll('.color-option').forEach(color => {
        color.addEventListener('click', selectColor.bind(null, color));
        color.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') selectColor(color);
        });
    });

    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            gameState.mode = btn.dataset.mode;
            startNewGame();
        });
    });

    document.getElementById('quit-btn').addEventListener('click', quitToMainMenu);
    document.getElementById('next-round-btn').addEventListener('click', startNewRound);
    document.getElementById('quit-round-btn').addEventListener('click', quitToMainMenu);
    document.getElementById('play-again-btn').addEventListener('click', startNewGame);
    document.getElementById('main-menu-btn').addEventListener('click', quitToMainMenu);
    
    // Bonus game event listeners
    document.getElementById('play-bonus-game-btn').addEventListener('click', playBonusGame);
    document.getElementById('save-bonus-game-btn').addEventListener('click', saveBonusGame);
    document.getElementById('language-toggle').addEventListener('click', toggleLanguage);       
}

function selectAvatar(avatar) {
    document.querySelectorAll('.avatar').forEach(a => a.classList.remove('selected'));
    avatar.classList.add('selected');
    gameState.player.avatar = avatar.dataset.avatar;
    updatePlayerUI();
}

function selectColor(color) {
    document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
    color.classList.add('selected');
    gameState.player.theme = color.dataset.color;
    updatePlayerUI();
}

function updatePlayerUI() {
    const displayName = gameState.player.emoji ? `${gameState.player.name} ${gameState.player.emoji}` : gameState.player.name;
    document.getElementById('player-name').textContent = displayName;
    document.getElementById('final-player').textContent = displayName;
    const avatarElement = document.getElementById('player-avatar');
    if (avatarElement) avatarElement.textContent = gameState.player.avatar;
    
    // Update the theme
    document.getElementById('game-container').className = `theme-${gameState.player.theme}`;
}

function updateLogoutButton() {
    const logoutBtn = document.getElementById('logout-btn');
    if (gameState.player.name !== 'Invitado') {
        logoutBtn.style.display = 'block';
    } else {
        logoutBtn.style.display = 'none';
    }
}

function toggleLanguage() {
    currentLanguage = currentLanguage === 'es' ? 'en' : 'es';
    updateLanguage();
}

function updateRewardPath() {
    const steps = document.querySelectorAll('.reward-step');
    
    steps.forEach(step => {
        step.classList.remove('earned', 'next');
        const stepType = step.dataset.step;
        
        if (stepType === 'medal' && gameState.player.rewards.medals > 0) {
            step.classList.add('earned');
        } else if (stepType === 'trophy' && gameState.player.rewards.trophies > 0) {
            step.classList.add('earned');
        }
    });
    
    if (gameState.player.rewards.medals < 10) {
        document.querySelector('.reward-step[data-step="medal"]').classList.add('next');
    } else if (gameState.player.rewards.trophies < 10) {
        document.querySelector('.reward-step[data-step="trophy"]').classList.add('next');
    }
}

function loadSelectedUser() {
    const userSelect = document.getElementById('user-select');
    const username = userSelect.value;
    const usernameInput = document.getElementById('username-input');
    
    if (username) {
        try {
            const savedData = localStorage.getItem(`nandomodeProgress_${username}`);
            if (savedData) {
                const playerData = JSON.parse(savedData);
                
                // Always show the input field
                usernameInput.style.display = 'block';
                usernameInput.placeholder = `¬°Bienvenido de nuevo, ${username}!`;
                
                // Update game state
                gameState.player = {
                    name: username,
                    avatar: playerData.avatar || 'üêâ',
                    theme: playerData.theme || 'green',
                    emoji: playerData.emoji || '',
                    points: playerData.points || 0,
                    rewards: playerData.rewards || { 
                        medals: 0,
                        trophies: 0,
                        totalWordsMastered: 0
                    },
                    unlockedStickers: playerData.unlockedStickers || [],
                    bonusGamesAvailable: playerData.bonusGamesAvailable || 0
                };
                
                gameState.streak = playerData.streak || 0;
                gameState.completedWords = playerData.completedWords || 0;
                gameState.wordProgress = playerData.wordProgress || {};
                
                // Update UI
                document.querySelectorAll('.avatar').forEach(avatar => {
                    avatar.classList.toggle('selected', avatar.dataset.avatar === gameState.player.avatar);
                });
                
                document.querySelectorAll('.color-option').forEach(color => {
                    color.classList.toggle('selected', color.dataset.color === gameState.player.theme);
                });
                
                updatePlayerUI();
                updateLogoutButton();
                updateProgressTracker();
                showSuccess(`¬°Bienvenido de nuevo, ${username}!`);
                return;
            }
        } catch (e) {
            console.error("Error loading user data:", e);
            showError("Error al cargar datos de usuario. Empezando de nuevo.");
        }
    }
    
    // Default to showing input field for new users
    usernameInput.style.display = 'block';
    usernameInput.placeholder = 'Escribe nuevo nombre...';
    gameState.player = {
        name: 'Invitado',
        avatar: 'üêâ',
        theme: 'green',
        emoji: '',
        points: 0,
        rewards: { 
            medals: 0,
            trophies: 0,
            totalWordsMastered: 0
        },
        unlockedStickers: [],
        bonusGamesAvailable: 0
    };
    gameState.streak = 0;
    gameState.completedWords = 0;
    gameState.wordProgress = {};
    updatePlayerUI();
    updateLogoutButton();
    updateProgressTracker();
}

function saveUsername() {
    const usernameInput = document.getElementById('username-input');
    const username = usernameInput.value.trim();
    
    if (!username) {
        showError("Por favor introduce un nombre de usuario");
        return;
    }
    
    // Always show the input field
    usernameInput.style.display = 'block';
    
    // Check if this is a new user or existing user
    const isNewUser = !gameState.leaderboard.some(user => user.name === username);
    
    if (isNewUser) {
        // Initialize new user data
        gameState.player = {
            name: username,
            avatar: gameState.player.avatar || 'üêâ',
            theme: gameState.player.theme || 'green',
            emoji: '',
            points: 0,
            rewards: { 
                medals: 0,
                trophies: 0,
                totalWordsMastered: 0
            },
            unlockedStickers: [],
            bonusGamesAvailable: 0
        };
        
        gameState.streak = 0;
        gameState.completedWords = 0;
        gameState.wordProgress = {};
    }
    
    localStorage.setItem('nandomodeCurrentPlayer', username);
    savePlayerProgress();
    
    updatePlayerUI();
    updateLogoutButton();
    updateProgressTracker();
    
    usernameInput.value = '';
    usernameInput.placeholder = isNewUser ? `¬°Bienvenido, ${username}!` : `¬°Bienvenido de nuevo, ${username}!`;
    
    const btn = document.getElementById('save-username');
    btn.textContent = isNewUser ? '‚úì ¬°Nuevo Usuario Creado!' : '‚úì ¬°Usuario Cargado!';
    setTimeout(() => btn.textContent = 'üíæ Guardar & Continuar', 1500);
    
    populateUserSelect();
    document.getElementById('user-select').value = username;
    
    showSuccess(isNewUser ? `¬°Nueva cuenta creada para ${username}!` : `¬°Bienvenido de nuevo ${username}!`);
}

function quickPlay() {
    // Only set guest mode if no user is currently logged in
    if (gameState.player.name === 'Invitado') {
        gameState.player = {
            name: 'Invitado',
            avatar: 'üêâ',
            theme: 'green',
            emoji: '',
            points: 0,
            rewards: { 
                medals: 0,
                trophies: 0,
                totalWordsMastered: 0
            },
            unlockedStickers: [],
            bonusGamesAvailable: 0
        };
        gameState.streak = 0;
        gameState.completedWords = 0;
        gameState.wordProgress = {};
        
        updatePlayerUI();
        updateLogoutButton();
        updateProgressTracker();
        showSuccess("Jugando como Invitado. El progreso no se guardar√°.");
    }
    showScreen('start');
}

function logout() {
    gameState.player = {
        name: 'Invitado',
        avatar: 'üêâ',
        theme: 'green',
        emoji: '',
        points: 0,
        rewards: { 
            medals: 0,
            trophies: 0,
            totalWordsMastered: 0
        },
        unlockedStickers: [],
        bonusGamesAvailable: 0
    };
    gameState.streak = 0;
    gameState.completedWords = 0;
    gameState.wordProgress = {};
    
    localStorage.removeItem('nandomodeCurrentPlayer');
    
    updatePlayerUI();
    updateLogoutButton();
    updateProgressTracker();
    populateUserSelect();
    
    document.getElementById('username-input').style.display = 'block';
    document.getElementById('username-input').placeholder = 'Escribe nuevo nombre...';
    document.getElementById('user-select').value = '';
    
    showSuccess("Sesi√≥n cerrada correctamente");
    showScreen('start');
}

function savePlayerProgress() {
    if (gameState.player.name === 'Invitado') {
        console.log('Not saving progress for Guest user');
        return;
    }
    
    try {
        const playerData = {
            name: gameState.player.name,
            avatar: gameState.player.avatar,
            theme: gameState.player.theme,
            emoji: gameState.player.emoji,
            points: gameState.player.points,
            rewards: gameState.player.rewards,
            wordProgress: gameState.wordProgress,
            completedWords: gameState.completedWords,
            streak: gameState.streak,
            unlockedStickers: gameState.player.unlockedStickers,
            bonusGamesAvailable: gameState.player.bonusGamesAvailable,
            lastActive: new Date().toISOString()
        };
        
        localStorage.setItem(`nandomodeProgress_${gameState.player.name}`, JSON.stringify(playerData));
        localStorage.setItem('nandomodeCurrentPlayer', gameState.player.name);
        console.log('Progress saved for:', gameState.player.name);
    } catch (e) {
        console.error("Error saving player progress:", e);
        showError("No se pudo guardar el progreso. ¬°Int√©ntalo de nuevo!");
    }
}

function loadPlayerProgress() {
    try {
        const savedName = localStorage.getItem('nandomodeCurrentPlayer');
        if (savedName) {
            const savedData = localStorage.getItem(`nandomodeProgress_${savedName}`);
            if (savedData) {
                const playerData = JSON.parse(savedData);
                
                gameState.player = {
                    name: savedName,
                    avatar: playerData.avatar || 'üêâ',
                    theme: playerData.theme || 'green',
                    emoji: playerData.emoji || '',
                    points: playerData.points || 0,
                    rewards: playerData.rewards || { 
                        medals: 0,
                        trophies: 0,
                        totalWordsMastered: 0
                    },
                    unlockedStickers: playerData.unlockedStickers || [],
                    bonusGamesAvailable: playerData.bonusGamesAvailable || 0
                };
                
                gameState.streak = playerData.streak || 0;
                gameState.completedWords = playerData.completedWords || 0;
                gameState.wordProgress = playerData.wordProgress || {};
                
                document.getElementById('username-input').placeholder = `¬°Bienvenido de nuevo, ${gameState.player.name}!`;
                document.querySelectorAll('.avatar').forEach(avatar => {
                    avatar.classList.toggle('selected', avatar.dataset.avatar === gameState.player.avatar);
                });
                document.querySelectorAll('.color-option').forEach(color => {
                    color.classList.toggle('selected', color.dataset.color === gameState.player.theme);
                });
                
                updatePlayerUI();
                updateLogoutButton();
                updateProgressTracker();
                return;
            }
        }
    } catch (e) {
        console.warn("Error loading player progress:", e);
        showError("No se pudo cargar tu progreso. ¬°Empezando de nuevo!");
    }
    
    gameState.player = {
        name: 'Invitado',
        avatar: 'üêâ',
        theme: 'green',
        emoji: '',
        points: 0,
        rewards: { 
            medals: 0,
            trophies: 0,
            totalWordsMastered: 0
        },
        unlockedStickers: [],
        bonusGamesAvailable: 0
    };
    gameState.streak = 0;
    gameState.completedWords = 0;
    gameState.wordProgress = {};
    
    updatePlayerUI();
    updateLogoutButton();
    updateProgressTracker();
}

function startNewGame() {
    document.getElementById('game-container').className = `theme-${gameState.player.theme}`;
    startNewRound();
    savePlayerProgress();
}

function startNewRound() {
    roundsPlayed++;
    setupClassicMode();
    showScreen('game');
}

function generateRoundData() {
    gameState.currentRound = {
        pairs: [],
        leftColumn: [],
        rightColumn: [],
        selectedLeft: null,
        selectedRight: null,
        matchedPairs: [],
        roundPoints: 0
    };
    
    const vocab = window.vocab && window.vocab.length > 0 ? window.vocab : defaultVocab;
    const newWords = getNewWords(3);
    const reviewWords = getReviewWords(2);
    const roundWords = shuffleArray([...newWords, ...reviewWords]);
    
    console.log(`Round words: ${roundWords.join(', ')}`);
    
    roundWords.forEach(word => {
        const vocabItem = vocab.find(item => item.word === word);
        if (vocabItem) {
            const pairId = sanitizePairId(word);
            gameState.currentRound.pairs.push({
                pairId,
                word: vocabItem.word,
                emoji: vocabItem.emoji,
                type: vocabItem.type,
                en: vocabItem.en,
                jp: vocabItem.jp
            });
        }
    });
    
    gameState.currentRound.pairs = shuffleArray([...gameState.currentRound.pairs]);
    
    const emojis = gameState.currentRound.pairs.map(pair => ({
        pairId: pair.pairId,
        type: 'emoji',
        value: pair.emoji
    }));
    const words = gameState.currentRound.pairs.map(pair => ({
        pairId: pair.pairId,
        type: 'word',
        value: pair.word
    }));
    
    const shuffledEmojis = shuffleArray([...emojis]);
    const shuffledWords = shuffleArray([...words]);
    
    if (gameState.mode === 'easy') {
        gameState.currentRound.leftColumn = shuffledEmojis;
        gameState.currentRound.rightColumn = shuffledWords;
    } else {
        gameState.currentRound.leftColumn = shuffledWords;
        gameState.currentRound.rightColumn = shuffledEmojis;
    }
    
    console.log('Generated pairs:', gameState.currentRound.pairs.map(p => `${p.word} (${p.pairId})`));
    console.log('Left Column:', gameState.currentRound.leftColumn.map(item => `${item.value} (${item.pairId})`));
    console.log('Right Column:', gameState.currentRound.rightColumn.map(item => `${item.value} (${item.pairId})`));
}

function getNewWords(count) {
    const vocab = window.vocab && window.vocab.length > 0 ? window.vocab : defaultVocab;
    const unseenWords = vocab
        .filter(item => !gameState.wordProgress[item.word])
        .map(item => item.word);
    
    if (unseenWords.length < count) {
        const seenWords = Object.keys(gameState.wordProgress).filter(word => gameState.wordProgress[word] < 3);
        const candidates = [...unseenWords, ...seenWords];
        return shuffleArray(candidates).slice(0, count);
    }
    
    return shuffleArray(unseenWords).slice(0, count);
}

function getReviewWords(count) {
    const reviewCandidates = Object.keys(gameState.wordProgress)
        .filter(word => gameState.wordProgress[word] > 0 && gameState.wordProgress[word] < 3);
    
    if (reviewCandidates.length < count) {
        return getNewWords(count);
    }
    
    return shuffleArray(reviewCandidates).slice(0, count);
}

function setupClassicMode() {
    generateRoundData();
    const gameBoard = document.getElementById('game-board');
    gameBoard.className = 'game-board';
    
    // Clear any existing columns
    gameBoard.innerHTML = '';
    
    const leftColumn = document.createElement('div');
    leftColumn.className = 'column';
    leftColumn.id = 'column-left';
    
    const rightColumn = document.createElement('div');
    rightColumn.className = 'column';
    rightColumn.id = 'column-right';
    
    gameBoard.appendChild(leftColumn);
    gameBoard.appendChild(rightColumn);
    
    // Now that columns exist, we can safely update the UI
    updateGameUI();
}

function updateGameUI() {
    // Safely update score display if it exists
    const scoreElement = document.getElementById('score');
    if (scoreElement) scoreElement.textContent = gameState.player.points;
    
    // Safely update streak display if it exists
    const streakElement = document.getElementById('streak');
    if (streakElement) streakElement.textContent = gameState.streak;
    
    // Safely update progress display if it exists
    const progressElement = document.getElementById('progress');
    if (progressElement) {
        progressElement.textContent = 
            `${gameState.completedWords}/50 (Total: ${gameState.player.rewards.totalWordsMastered})`;
    }
    
    // Safely update percent complete if it exists
    const percentElement = document.getElementById('percent-complete');
    if (percentElement) {
        percentElement.textContent = Math.round((gameState.completedWords / 50) * 100);
    }
    
    updateProgressBar();
    updateRewardPath();
    updateProgressTracker();
            
    const leftColumn = document.getElementById('column-left');
    const rightColumn = document.getElementById('column-right');
    
    // Only proceed if both columns exist
    if (!leftColumn || !rightColumn) return;
    
    leftColumn.innerHTML = '';
    rightColumn.innerHTML = '';
            
    gameState.currentRound.leftColumn.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = `card ${item.type === 'emoji' ? 'emoji-card' : 'word-card'}`;
        card.dataset.pairId = item.pairId;
        card.dataset.type = item.type;
        card.textContent = item.value;
        card.tabIndex = gameState.currentRound.matchedPairs.includes(item.pairId) ? -1 : 0;
        card.setAttribute('role', 'button');
        card.setAttribute('aria-label', `Seleccionar tarjeta: ${item.value}`);
        
        if (gameState.currentRound.matchedPairs.includes(item.pairId)) {
            card.classList.add('matched');
        }
        
        const pair = gameState.currentRound.pairs.find(p => p.pairId === item.pairId);
        if (pair && gameState.wordProgress[pair.word]) {
            card.classList.add(`word-mastery-${Math.min(3, gameState.wordProgress[pair.word])}`);
        }
        
        card.addEventListener('click', () => handleCardClick('left', item.pairId, index));
        card.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') handleCardClick('left', item.pairId, index);
        });
        
        leftColumn.appendChild(card);
    });
    
    gameState.currentRound.rightColumn.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = `card ${item.type === 'emoji' ? 'emoji-card' : 'word-card'}`;
        card.dataset.pairId = item.pairId;
        card.dataset.type = item.type;
        card.textContent = item.value;
        card.tabIndex = gameState.currentRound.matchedPairs.includes(item.pairId) ? -1 : 0;
        card.setAttribute('role', 'button');
        card.setAttribute('aria-label', `Seleccionar tarjeta: ${item.value}`);
        
        if (gameState.currentRound.matchedPairs.includes(item.pairId)) {
            card.classList.add('matched');
        }
        
        const pair = gameState.currentRound.pairs.find(p => p.pairId === item.pairId);
        if (pair && gameState.wordProgress[pair.word]) {
            card.classList.add(`word-mastery-${Math.min(3, gameState.wordProgress[pair.word])}`);
        }
        
        card.addEventListener('click', () => handleCardClick('right', item.pairId, index));
        card.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') handleCardClick('right', item.pairId, index);
        });
        
        rightColumn.appendChild(card);
    });
    
    if (gameState.currentRound.matchedPairs.length === gameState.currentRound.pairs.length) {
        console.log('All pairs matched, ending round');
        endRound();
    }
}

function updateProgressBar() {
    const progressBar = document.querySelector('.progress-bar');
    const percent = Math.min(100, (gameState.completedWords / totalWords) * 100);
    progressBar.style.width = `${percent}%`;
}

function handleCardClick(column, pairId, index) {
    if (isProcessingClick || gameState.currentRound.matchedPairs.includes(pairId)) {
        console.log(`Skipped click: isProcessing=${isProcessingClick}, pairId=${pairId}, matched=${gameState.currentRound.matchedPairs.includes(pairId)}`);
        return;
    }
    isProcessingClick = true;
    
    const columnData = column === 'left' ? gameState.currentRound.leftColumn : gameState.currentRound.rightColumn;
    const item = columnData[index];
    if (!item || item.pairId !== pairId) {
        console.error(`Item mismatch: pairId=${pairId}, index=${index}, column=${column}, found=${!!item}`);
        isProcessingClick = false;
        showError("¬°Vaya! Algo sali√≥ mal. ¬°Int√©ntalo de nuevo!");
        return;
    }
    
    const card = document.querySelector(`.card[data-pair-id="${pairId}"][data-type="${item.type}"]`);
    if (!card || card.classList.contains('matched')) {
        console.error(`Invalid card: pairId=${pairId}, type=${item.type}, column=${column}, found=${!!card}`);
        isProcessingClick = false;
        showError("¬°Vaya! Algo sali√≥ mal. ¬°Int√©ntalo de nuevo!");
        return;
    }
    
    if (gameState.mode !== 'hard' && column === 'left') {
        const pair = gameState.currentRound.pairs.find(p => p.pairId === pairId);
        if (pair) {
            const now = Date.now();
            if (now - lastTTSTime >= ttsDebounce) {
                speakWord(pair.word);
                lastTTSTime = now;
                console.log(`TTS triggered: word=${pair.word}`);
            }
        }
    }
    
    if (column === 'left') {
        if (gameState.currentRound.selectedLeft) {
            const prevCard = document.querySelector(`.card[data-pair-id="${gameState.currentRound.selectedLeft}"]`);
            if (prevCard) prevCard.classList.remove('selected');
        }
        gameState.currentRound.selectedLeft = pairId;
        card.classList.add('selected');
    } else {
        if (gameState.currentRound.selectedRight) {
            const prevCard = document.querySelector(`.card[data-pair-id="${gameState.currentRound.selectedRight}"]`);
            if (prevCard) prevCard.classList.remove('selected');
        }
        gameState.currentRound.selectedRight = pairId;
        card.classList.add('selected');
    }
    
    console.log(`Selected: left=${gameState.currentRound.selectedLeft}, right=${gameState.currentRound.selectedRight}`);
    
    if (gameState.currentRound.selectedLeft && gameState.currentRound.selectedRight) {
        checkMatch();
    } else {
        isProcessingClick = false;
    }
}

function checkMatch() {
    const leftId = gameState.currentRound.selectedLeft;
    const rightId = gameState.currentRound.selectedRight;
    
    console.log(`Checking match: leftId=${leftId}, rightId=${rightId}, matchedPairs=${gameState.currentRound.matchedPairs.length}`);
    
    const leftCard = document.querySelector(`.card[data-pair-id="${leftId}"]`);
    const rightCard = document.querySelector(`.card[data-pair-id="${rightId}"]`);
    
    if (!leftCard || !rightCard) {
        console.error(`Cards not found in checkMatch: leftCard=${leftCard}, rightCard=${rightCard}, leftId=${leftId}, rightId=${rightId}`);
        resetSelections();
        showError("¬°Vaya! Algo sali√≥ mal. ¬°Int√©ntalo de nuevo!");
        return;
    }
    
if (leftId === rightId) {
    // Correct match
    playSound('correct');
    
    // Calculate points - double for hard mode
    const basePoints = gameState.mode === 'hard' ? 20 : 10;
    gameState.player.points += basePoints;
    gameState.streak++;
    gameState.currentRound.roundPoints += basePoints;
    matchesCompleted++;
    matchesInRound++;
    
    // Check for bonus game every 5 matches
    if (matchesInRound >= 5) {
        matchesInRound = 0;
        showBonusGamePopup();
        
        // Play musical flourish if perfect round
        if (perfectRound) {
            playSound('win');
            createConfetti(document.getElementById('game-screen'), 30);
            showNotification("¬°Ronda Perfecta! ¬°5/5 correctas!");
        } else {
            playSound('flamenco');
        }
        
        perfectRound = true; // Reset for next round
    }
        
        const pair = gameState.currentRound.pairs.find(p => p.pairId === leftId);
        if (pair) {
            gameState.wordProgress[pair.word] = (gameState.wordProgress[pair.word] || 0) + 1;
            if (gameState.wordProgress[pair.word] === 3) {
                gameState.completedWords++;
                gameState.player.rewards.totalWordsMastered++;
                checkMilestone();
                checkModeCompletion();
            }
            
            // Show translations for matched cards
            const translationDisplay = document.getElementById('translation-display');
            if (pair.en || pair.jp) {
                translationDisplay.innerHTML = `
                    <span class="word">${pair.word}</span>
                    ${pair.en ? `<span class="translation">EN: ${pair.en}</span>` : ''}
                    ${pair.jp ? `<span class="translation">JP: ${pair.jp}</span>` : ''}
                `;
                translationDisplay.style.display = 'block';
                setTimeout(() => {
                    translationDisplay.style.display = 'none';
                }, 3000);
            }
        }
        
        gameState.currentRound.matchedPairs.push(leftId);
        console.log(`Match successful, matchedPairs=${gameState.currentRound.matchedPairs.length}`);
        
        if (gameState.streak % 5 === 0) {
            const bonus = gameState.streak * 2;
            gameState.player.points += bonus;
            showNotification(`¬°Bonus de Racha: +${bonus} Puntos!`);
            playSound('flamenco'); // Flamenco flourish for streak bonus
        }
        
        leftCard.classList.add('correct');
        rightCard.classList.add('correct');
        
        setTimeout(() => {
            leftCard.classList.remove('correct');
            rightCard.classList.remove('correct');
            leftCard.classList.add('matched');
            rightCard.classList.add('matched');
            leftCard.tabIndex = -1;
            rightCard.tabIndex = -1;
            gameState.currentRound.selectedLeft = null;
            gameState.currentRound.selectedRight = null;
            isProcessingClick = false;
            
            if (gameState.currentRound.matchedPairs.length === gameState.currentRound.pairs.length) {
                console.log('All pairs matched, ending round');
                endRound();
            } else {
                updateGameUI();
            }
        }, 500);
    } else {
        // Incorrect match
        playSound('incorrect');
        gameState.streak = 0;
    perfectRound = false;
    matchesInRound++;
        
        leftCard.classList.add('incorrect');
        rightCard.classList.add('incorrect');
        
        setTimeout(() => {
            leftCard.classList.remove('selected', 'incorrect');
            rightCard.classList.remove('selected', 'incorrect');
            gameState.currentRound.selectedLeft = null;
            gameState.currentRound.selectedRight = null;
            isProcessingClick = false;
            updateGameUI();
        }, 1000);
    }
    
    savePlayerProgress();
}

function showBonusGamePopup() {
    document.getElementById('bonus-game-popup').style.display = 'flex';
    document.getElementById('fruit-machine').style.display = 'flex';
    document.getElementById('balloon-game').style.display = 'none';
}

function playBonusGame() {
    // Keep the popup visible but change its content
    document.getElementById('fruit-machine').style.display = 'flex';
    document.getElementById('balloon-game').style.display = 'none';
    
    // Hide the buttons since we're playing now
    document.querySelector('.bonus-game-buttons').style.display = 'none';
    
    // Add a close button
    const closeButton = document.createElement('button');
    closeButton.textContent = '‚úñ Close';
    closeButton.addEventListener('click', () => {
        document.getElementById('bonus-game-popup').style.display = 'none';
        document.querySelector('.bonus-game-buttons').style.display = 'flex';
    });
    
    const content = document.querySelector('.bonus-game-content');
    if (!content.querySelector('#close-bonus-btn')) {
        content.appendChild(closeButton);
        closeButton.id = 'close-bonus-btn';
    }
    
    // Start the fruit machine game
    playFruitMachine();
}

function saveBonusGame() {
    // Hide the popup
    document.getElementById('bonus-game-popup').style.display = 'none';
    
    // Save the bonus game for later
    gameState.player.bonusGamesAvailable++;
    showSuccess(`¬°Bonus Game guardado! Ahora tienes ${gameState.player.bonusGamesAvailable} juegos disponibles.`);
    
    // Update UI
    savePlayerProgress();
}

function playFruitMachine() {
    const fruits = ['üçé', 'üçä', 'üçã', 'ü•ë'];
    const reels = [
        document.getElementById('fruit-reel-1'),
        document.getElementById('fruit-reel-2'),
        document.getElementById('fruit-reel-3')
    ];
    
    // Disable play button during spin
    const playBtn = document.getElementById('play-bonus-game-btn');
    if (playBtn) playBtn.disabled = true;
    
    // Play spin sound
    playSound('spin');
    
    // Spin each reel with different durations
    const spinDurations = [1000, 1500, 2000];
    const results = [];
    
    reels.forEach((reel, index) => {
        const startTime = Date.now();
        const spinInterval = setInterval(() => {
            reel.textContent = fruits[Math.floor(Math.random() * fruits.length)];
        }, 100);
        
        setTimeout(() => {
            clearInterval(spinInterval);
            // 33% chance all reels show the same fruit
            const shouldWin = Math.random() < 0.33;
            let result;
            
            if (shouldWin && index > 0) {
                // Force same result as first reel for a win
                result = results[0];
            } else {
                result = fruits[Math.floor(Math.random() * fruits.length)];
            }
            
            reel.textContent = result;
            results.push(result);
            
            // Visual feedback when reel stops
            reel.style.transform = 'scale(1.2)';
            reel.style.backgroundColor = 'rgba(255,255,255,0.2)';
            setTimeout(() => {
                reel.style.transform = 'scale(1)';
                reel.style.backgroundColor = 'transparent';
            }, 300);
            
            // Check if all reels have stopped
            if (results.length === 3) {
                if (playBtn) playBtn.disabled = false;
                
                // Add a slight delay before checking result
                setTimeout(() => {
                    checkFruitMachineResult(results);
                }, 500);
            }
        }, spinDurations[index]);
    });
}

function checkFruitMachineResult(results) {
    // Check for win (all fruits the same)
    if (results[0] === results[1] && results[1] === results[2]) {
        playSound('win');
        showSuccess("¬°Ganaste el juego de frutas! ¬°Ahora al juego de globos!");
        setTimeout(startBalloonGame, 1500);
    } else {
        showError("¬°Casi! Int√©ntalo de nuevo la pr√≥xima vez.");
    }
}

function startBalloonGame() {
    const balloonGame = document.getElementById('balloon-game');
    balloonGame.innerHTML = '';
    balloonGame.style.display = 'flex';
    
    // Create Spanish alphabet balloons
    const spanishAlphabet = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 
                            'N', '√ë', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
    
    // Shuffle and take 10 random letters
    const shuffledLetters = shuffleArray([...spanishAlphabet]).slice(0, 10);
    
    shuffledLetters.forEach(letter => {
        const balloon = document.createElement('div');
        balloon.className = 'balloon';
        balloon.textContent = letter;
        balloon.addEventListener('click', () => popBalloon(balloon, letter));
        balloonGame.appendChild(balloon);
    });
    
    // Set 30-second timer
    let timeLeft = 30;
    const timerDisplay = document.createElement('div');
    timerDisplay.style.textAlign = 'center';
    timerDisplay.style.width = '100%';
    timerDisplay.style.fontSize = '1.5rem';
    timerDisplay.style.margin = '10px 0';
    timerDisplay.textContent = `Tiempo: ${timeLeft}s`;
    balloonGame.insertBefore(timerDisplay, balloonGame.firstChild);
    
    const timer = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `Tiempo: ${timeLeft}s`;
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            endBalloonGame();
        }
    }, 1000);
}

function popBalloon(balloon, letter) {
    balloon.style.display = 'none';
    playSound('pop');
    speakLetter(letter);
}

function speakLetter(letter) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(letter);
        utterance.lang = 'es-ES';
        utterance.rate = 0.8;
        speechSynthesis.speak(utterance);
    }
}

function endBalloonGame() {
    document.getElementById('balloon-game').style.display = 'none';
    
    // Award points based on performance
    const balloonsPopped = document.querySelectorAll('.balloon[style*="display: none"]').length;
    const bonusPoints = balloonsPopped * 5;
    gameState.player.points += bonusPoints;
    
    showSuccess(`¬°Ganaste ${bonusPoints} puntos en el juego de globos!`);
    savePlayerProgress();
}

function resetSelections() {
    gameState.currentRound.selectedLeft = null;
    gameState.currentRound.selectedRight = null;
    document.querySelectorAll('.card.selected').forEach(card => card.classList.remove('selected'));
    isProcessingClick = false;
    updateGameUI();
}

function checkMilestone() {
    const previousWords = gameState.completedWords - 1;
    const currentWords = gameState.completedWords;
    if (milestones.includes(currentWords) && !milestones.includes(previousWords)) {
        showNotification(`¬°Logro! ${currentWords}/50 palabras dominadas`);
    }
}

function checkModeCompletion() {
    // Award medals for every 50 words
    if (gameState.player.rewards.totalWordsMastered > 0 && 
        gameState.player.rewards.totalWordsMastered % 50 === 0) {
        
        // Reset the completed words counter but keep total progress
        gameState.completedWords = 0;
        
        gameState.player.rewards.medals++;
        showNotification(`üéñÔ∏è ¬°Medalla ganada!`);
        createConfetti(document.getElementById('game-screen'), 20);
        
        // Award trophies for every 500 words (10 medals)
        if (gameState.player.rewards.medals >= 10) {
            gameState.player.rewards.medals = 0;
            gameState.player.rewards.trophies++;
            showNotification(`üèÜ ¬°Trofeo ganado!`);
            createConfetti(document.getElementById('game-screen'), 20);
        }
        
        savePlayerProgress();
        updateProgressTracker();
    }
}

function endRound() {
    document.getElementById('round-score').textContent = gameState.currentRound.roundPoints;
    document.getElementById('total-score').textContent = gameState.player.points;
    
    // Update to show both current and total progress
    document.getElementById('progress-count').textContent = 
        `${gameState.completedWords}/50 (Total: ${gameState.player.rewards.totalWordsMastered})`;
    
    document.getElementById('progress-streak').textContent = gameState.streak;
    
    updateTrophyDisplay(document.getElementById('trophy-display'));
    updateRewardPath();
    updateProgressTracker();
    
    savePlayerProgress();
    
    setTimeout(() => {
        createConfetti(document.getElementById('round-complete-screen'), 20);
        showScreen('roundComplete');
        
        // Check for level up milestone
        if (milestones.includes(gameState.completedWords)) {
            setTimeout(() => {
                showNotification(`¬°Nivel alcanzado! ${gameState.completedWords} palabras dominadas`);
                createConfetti(document.getElementById('round-complete-screen'), 30);
            }, 500);
        }
    }, 1000);
}

function updateTrophyDisplay(container) {
    container.innerHTML = '';
    
    if (gameState.player.rewards.medals > 0) {
        const medalDiv = document.createElement('div');
        medalDiv.className = 'trophy-item';
        medalDiv.textContent = 'üéñÔ∏è';
        medalDiv.title = `${gameState.player.rewards.medals} Medallas`;
        container.appendChild(medalDiv);
    }
    if (gameState.player.rewards.trophies > 0) {
        const trophyDiv = document.createElement('div');
        trophyDiv.className = 'trophy-item';
        trophyDiv.textContent = 'üèÜ';
        trophyDiv.title = `${gameState.player.rewards.trophies} Trofeos`;
        container.appendChild(trophyDiv);
    }
    
    if (container.innerHTML === '') {
        container.textContent = '¬°Gana recompensas dominando palabras!';
    }
}

function showTrophyRoom() {
    updateTrophyDisplay(document.getElementById('trophy-list'));
    showScreen('trophyRoom');
}

function endGame() {
    gameState.leaderboard.push({
        name: gameState.player.name,
        avatar: gameState.player.avatar,
        score: gameState.player.points,
        date: new Date().toISOString()
    });
    
    gameState.leaderboard.sort((a, b) => b.score - a.score);
    gameState.leaderboard = gameState.leaderboard.slice(0, 20);
    
    try {
        localStorage.setItem('nandomodeLeaderboard', JSON.stringify(gameState.leaderboard));
    } catch (e) {
        console.warn("Error saving leaderboard:", e);
        showError("No se pudo guardar el marcador. ¬°Int√©ntalo de nuevo!");
    }
    
    document.getElementById('final-score').textContent = gameState.player.points;
    updateTrophyDisplay(document.getElementById('final-trophy-display'));
    
    showScreen('gameOver');
}

function quitToMainMenu() {
    showScreen('start');
    populateUserSelect();
}

function showScreen(screenName) {
    Object.values(screens).forEach(screen => screen.classList.remove('active'));
    screens[screenName].classList.add('active');
    gameState.currentScreen = screenName;
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function createConfetti(container, count) {
    const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ffbe0b', '#fb5607', '#8338ec'];
    
    for (let i = 0; i < Math.min(count, 20); i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDuration = `${Math.random() * 1 + 1}s`;
        confetti.style.width = `${Math.random() * 6 + 4}px`;
        confetti.style.height = `${Math.random() * 6 + 4}px`;
        container.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 2000);
    }
}

function speakWord(word) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'es-ES';
        utterance.rate = 0.8;
        speechSynthesis.speak(utterance);
    } else {
        console.warn("SpeechSynthesis not supported.");
    }
}

function sanitizePairId(word) {
    return word.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}
</script>
</body>
</html>
