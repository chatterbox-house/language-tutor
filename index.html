<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NANDOmode - Aprende Vocabulario Español</title>
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Aprende vocabulario español con divertidos juegos de emparejar">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Comic Neue', cursive, 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            touch-action: manipulation;
        }
        
        #game-container {
            max-width: 900px;
            width: 100%;
            background: rgba(10, 15, 30, 0.85);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            position: relative;
            border: 6px solid #4a4a8a;
        }
        
        .screen {
            display: none;
            padding: 30px 20px;
            min-height: 600px;
        }
        
        .active {
            display: block;
        }
        
        h1, h2, h3 {
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.7);
            font-weight: bold;
            line-height: 1.3;
        }
        
        h1 {
            font-size: 2.8rem;
            margin: 25px 0 15px;
            letter-spacing: 4px;
            color: #f8f8f8;
            text-transform: uppercase;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #ffe66d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
        }
        
        h2 {
            font-size: 2rem;
            margin: 20px 0;
            color: #ffe66d;
        }
        
        h3 {
            font-size: 1.5rem;
            margin: 15px 0;
            color: #4ecdc4;
        }
        
        button {
            background: linear-gradient(145deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 18px 30px;
            font-size: 1.5rem;
            font-family: 'Comic Neue', cursive;
            cursor: pointer;
            margin: 15px;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            border: 3px solid #ff4757;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        button:hover {
            transform: translateY(-4px) scale(1.05);
            background: linear-gradient(145deg, #ff8e8e, #ff6b6b);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        
        .btn-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 25px 0;
        }
        
        .mode-btn {
            min-width: 220px;
            margin: 12px;
            padding: 20px;
            font-size: 1.4rem;
            border-radius: 20px;
        }
        
        .mode-btn.easy { 
            background: linear-gradient(145deg, #3a7, #4bc); 
            border: 3px solid #2aa;
        }
        .mode-btn.medium { 
            background: linear-gradient(145deg, #47a, #58c); 
            border: 3px solid #36b;
        }
        .mode-btn.hard { 
            background: linear-gradient(145deg, #a54, #d66); 
            border: 3px solid #c33;
        }
        
        #start-screen {
            background: radial-gradient(circle at center, #1e3a5f, #132238);
            text-align: center;
        }
        
        .username-container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 3px solid #4ecdc4;
        }
        
        #username-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3rem;
            font-family: inherit;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            margin: 15px 0;
        }
        
        #user-select {
            width: 100%;
            padding: 15px;
            font-size: 1.3rem;
            font-family: inherit;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            margin: 15px 0;
        }
        
        .avatar-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .avatar {
            font-size: 5rem;
            margin: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 3px solid transparent;
            animation: avatarPulse 2s infinite ease-in-out;
        }
        
        .avatar:hover {
            transform: scale(1.15);
            background: rgba(255, 255, 255, 0.1);
            animation: none;
        }
        
        .avatar.selected {
            transform: scale(1.25);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.8);
            border: 3px solid #ffe66d;
            animation: none;
        }
        
        @keyframes avatarPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .color-picker {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .color-option {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 0 12px;
            cursor: pointer;
            border: 3px solid #555;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            transform: scale(1.25);
            border: 4px solid white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        
        #game-screen {
            background: radial-gradient(circle at center, #1a2a3a, #0d1b2a);
        }
        
        .game-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 3px solid #4a4a8a;
        }
        
        .game-header div {
            font-size: 1.2rem;
            text-align: center;
            padding: 10px 5px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            border: 2px solid #4ecdc4;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .player-avatar {
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .game-header .progress-container {
            grid-column: 1 / span 2;
            width: 100%;
            margin: 10px 0 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            height: 30px;
            border: 2px solid #4a4a8a;
            overflow: hidden;
            padding: 0;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .game-board {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            min-height: 400px;
            gap: 10px;
        }
        
        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 45%;
        }
        
        .card {
            background: rgba(30, 40, 70, 0.8);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 140px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            border: 3px solid rgba(100, 100, 200, 0.3);
        }
        
        .card:hover {
            transform: translateY(-5px);
            background: rgba(40, 50, 90, 0.9);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            border-color: rgba(100, 200, 255, 0.5);
        }
        
        .card.selected {
            background: rgba(100, 200, 255, 0.3);
            box-shadow: 0 0 20px rgba(100, 200, 255, 0.6);
            border: 3px solid rgba(100, 200, 255, 0.7);
        }
        
        .card.correct {
            background: rgba(100, 255, 100, 0.3);
            animation: pulse 0.5s ease;
        }
        
        .card.incorrect {
            background: rgba(255, 100, 100, 0.3);
            animation: shake 0.5s ease;
        }
        
        .card.matched {
            background: rgba(100, 255, 100, 0.5);
            border: 3px solid #4ecdc4;
            box-shadow: 0 0 15px rgba(100, 255, 100, 0.8);
            pointer-events: none;
            cursor: default;
        }
        
        .emoji-card {
            font-size: 4rem;
        }
        
        .word-card {
            font-size: 1.8rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 15px;
        }
        
        #round-complete-screen {
            background: radial-gradient(circle at center, #2a3a2a, #1a2a1a);
            text-align: center;
        }
        
        .round-result {
            font-size: 1.8rem;
            margin: 30px 0;
            padding: 25px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: 3px solid #4ecdc4;
            max-width: 600px;
            margin: 30px auto;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: fall 2s linear forwards;
        }
        
        #trophy-room-screen {
            background: radial-gradient(circle at center, #2a2a3a, #1a1a2a);
            text-align: center;
        }
        
        .trophy-container {
            max-width: 700px;
            margin: 20px auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            border: 3px solid #4ecdc4;
        }
        
        .trophy-item {
            font-size: 3rem;
            margin: 15px;
            display: inline-block;
            animation: trophySpin 2s infinite linear;
        }
        
        #emoji-store-screen {
            background: radial-gradient(circle at center, #2a2a3a, #1a1a2a);
            text-align: center;
        }
        
        .emoji-store-container {
            max-width: 700px;
            margin: 20px auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            border: 3px solid #4ecdc4;
        }
        
        .emoji-item {
            display: inline-flex;
            align-items: center;
            margin: 10px;
            padding: 15px;
            background: rgba(30, 40, 70, 0.8);
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s;
        }
        
        .emoji-item:hover {
            transform: scale(1.1);
        }
        
        .emoji-item.purchased {
            background: rgba(100, 255, 100, 0.5);
        }
        
        #game-over-screen {
            background: radial-gradient(circle at center, #3a2a2a, #2a1a1a);
            text-align: center;
        }
        
        .milestone-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #ffe66d;
            padding: 15px 30px;
            border-radius: 10px;
            border: 3px solid #4ecdc4;
            font-size: 1.2rem;
            z-index: 1000;
            animation: fadeInOut 3s ease forwards;
        }
        
        .error-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 100, 100, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            border: 3px solid #ff4757;
            font-size: 1.2rem;
            z-index: 1000;
            animation: fadeInOut 3s ease forwards;
        }
        
        .success-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(100, 255, 100, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            border: 3px solid #4ecdc4;
            font-size: 1.2rem;
            z-index: 1000;
            animation: fadeInOut 3s ease forwards;
        }
        
        .progress-tracker {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #4ecdc4;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .daily-streak {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 5px;
        }
        
        .streak-fire {
            color: #ff6b6b;
            animation: flamePulse 1s infinite alternate;
        }
        
        .reward-path {
            display: flex;
            justify-content: space-between;
            margin: 20px auto;
            max-width: 500px;
        }
        
        .reward-step {
            text-align: center;
            opacity: 0.5;
            transition: all 0.3s;
            font-size: 2rem;
        }
        
        .reward-step.earned {
            opacity: 1;
            transform: scale(1.1);
            filter: drop-shadow(0 0 5px gold);
        }
        
        .reward-step.next {
            opacity: 0.8;
            text-shadow: 0 0 10px #ffe66d;
        }
        
        .reward-label {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .word-mastery-1 { border-color: #4ecdc4 !important; }
        .word-mastery-2 { border-color: silver !important; }
        .word-mastery-3 { border-color: gold !important; animation: pulse 1s infinite; }
        
        .logout-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 100, 100, 0.7);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid #ff4757;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background: rgba(255, 100, 100, 0.9);
            transform: translateY(-2px);
        }
        
        /* New kid-friendly elements */
        .character {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 5rem;
            z-index: 100;
            animation: bounce 2s infinite;
            cursor: pointer;
        }
        
        .music-control {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .sticker-collection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        
        .sticker {
            font-size: 2.5rem;
            margin: 10px;
            animation: wiggle 3s infinite;
        }
        
        .sticker.unlocked {
            filter: drop-shadow(0 0 5px gold);
        }
        
        .sticker.locked {
            opacity: 0.3;
            filter: grayscale(100%);
        }
        
        /* Bonus Game Styles */
        #bonus-game-screen {
            background: radial-gradient(circle at center, #3a2a1a, #2a1a0d);
            text-align: center;
        }
        
        .bonus-game-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: 3px solid #ff6b6b;
        }
        
        .bonus-game-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #ffe66d;
            text-shadow: 0 0 10px rgba(255, 230, 109, 0.7);
        }
        
        .bonus-game-instructions {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        
        .bonus-game-area {
            position: relative;
            width: 100%;
            height: 300px;
            margin: 20px 0;
            overflow: hidden;
            border-radius: 10px;
            border: 3px solid #4ecdc4;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .bonus-game-score {
            font-size: 1.5rem;
            margin: 10px 0;
            color: #ff6b6b;
        }
        
        .bonus-game-timer {
            font-size: 1.5rem;
            margin: 10px 0;
            color: #4ecdc4;
        }
        
        /* Piñata Game */
        .pinata {
            position: absolute;
            font-size: 8rem;
            cursor: pointer;
            animation: bounce 1s infinite alternate;
            transform-origin: center top;
            left: 50%;
            top: 50px;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        .pinata-hit {
            animation: pinataHit 0.3s;
        }
        
        .candy {
            position: absolute;
            font-size: 1.5rem;
            animation: fall 1s linear forwards;
            z-index: 5;
        }
        
        /* Bull Run Game */
        .bull {
            position: absolute;
            font-size: 5rem;
            left: -100px;
            top: 50%;
            transform: translateY(-50%);
            animation: bullRun 3s linear infinite;
        }
        
        .matador {
            position: absolute;
            font-size: 4rem;
            right: 20px;
            bottom: 20px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        /* Flamenco Game */
        .flamenco-dancer {
            position: absolute;
            font-size: 6rem;
            left: 50%;
            bottom: 20px;
            transform: translateX(-50%);
            cursor: pointer;
            animation: flamencoDance 1s infinite alternate;
        }
        
        .castanet {
            position: absolute;
            font-size: 2rem;
            animation: castanetFall 1s linear forwards;
        }
        
        /* Soccer Game */
        .soccer-goal {
            position: absolute;
            font-size: 8rem;
            left: 50%;
            bottom: 20px;
            transform: translateX(-50%);
        }
        
        .soccer-ball {
            position: absolute;
            font-size: 3rem;
            cursor: pointer;
            animation: soccerKick 1s infinite alternate;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Tapas Game */
        .tapas-plate {
            position: absolute;
            font-size: 4rem;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }
        
        .tapas-item {
            position: absolute;
            font-size: 2rem;
            animation: tapasFall 1s linear forwards;
        }
        
        /* Fiesta Game */
        .fiesta-item {
            position: absolute;
            font-size: 3rem;
            cursor: pointer;
            animation: fiestaFloat 3s infinite ease-in-out;
        }
        
        /* Gaudi Game */
        .gaudi-tile {
            position: absolute;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #ffe66d);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        /* Churro Game */
        .churro {
            position: absolute;
            font-size: 3rem;
            cursor: pointer;
            animation: churroFloat 2s infinite ease-in-out;
        }
        
        /* Maracas Game */
        .maraca {
            position: absolute;
            font-size: 4rem;
            cursor: pointer;
            animation: maracaShake 0.5s infinite alternate;
        }
        
        /* Don Quixote Game */
        .windmill {
            position: absolute;
            font-size: 6rem;
            animation: windmillSpin 5s linear infinite;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .don-quixote {
            position: absolute;
            font-size: 4rem;
            cursor: pointer;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* New Animations */
        @keyframes fadeInOut {
            0% { opacity: 0.3; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1.1); }
        }
        
        @keyframes fall {
            to { transform: translateY(400px); }
        }
        
        @keyframes pinataHit {
            0% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(15deg); }
            50% { transform: translateX(-50%) rotate(-15deg); }
            75% { transform: translateX(-50%) rotate(10deg); }
            100% { transform: translateX(-50%) rotate(0deg); }
        }
        
        @keyframes bullRun {
            0% { left: -100px; }
            100% { left: calc(100% + 100px); }
        }
        
        @keyframes flamencoDance {
            0% { transform: translateX(-50%) rotate(-5deg); }
            100% { transform: translateX(-50%) rotate(5deg); }
        }
        
        @keyframes castanetFall {
            0% { top: -50px; opacity: 1; }
            100% { top: 300px; opacity: 0; }
        }
        
        @keyframes soccerKick {
            0% { transform: translate(-50%, -50%) scale(1); }
            100% { transform: translate(-50%, -50%) scale(1.2); }
        }
        
        @keyframes tapasFall {
            0% { top: -50px; opacity: 1; }
            100% { top: 300px; opacity: 0; }
        }
        
        @keyframes fiestaFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes churroFloat {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        
        @keyframes maracaShake {
            0% { transform: rotate(-15deg); }
            100% { transform: rotate(15deg); }
        }
        
        @keyframes windmillSpin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* Mobile Scaling */
        .kid-mode .card {
            transform: scale(1.2);
            margin: 15px auto;
        }
        
        .kid-mode .game-board {
            flex-direction: column;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(100, 255, 100, 0.6); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(100, 255, 100, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(100, 255, 100, 0.6); }
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-15px); }
            50% { transform: translateX(15px); }
            75% { transform: translateX(-15px); }
            100% { transform: translateX(0); }
        }
        
        @keyframes trophySpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes flamePulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.2); }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            h2 { font-size: 1.6rem; }
            h3 { font-size: 1.2rem; }
            
            .game-header {
                grid-template-columns: 1fr 1fr;
            }
            
            .game-header div:nth-child(1), .game-header div:nth-child(2) {
                grid-column: 1 / span 2;
            }
            
            .game-header .progress-container {
                grid-column: 1 / span 2;
            }
            
            .game-board {
                flex-direction: row;
                gap: 10px;
            }
            
            .column {
                flex: 1;
                min-width: 45%;
            }
            
            .card {
                height: 120px;
                padding: 15px;
            }
            
            .emoji-card { font-size: 2.8rem; }
            .word-card { font-size: 1.4rem; }
            
            button { padding: 12px 20px; font-size: 1.1rem; }
            .mode-btn { min-width: 160px; padding: 15px; }
            
            .avatar { font-size: 4rem; margin: 8px; }
            .player-avatar { font-size: 1.5rem; }
            
            .progress-tracker, .logout-btn {
                position: static;
                margin: 10px auto;
                width: 90%;
            }
            
            .character {
                font-size: 3rem;
                bottom: 10px;
                right: 10px;
            }
            
            .music-control {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
                bottom: 10px;
                left: 10px;
            }
            
            .bonus-game-area {
                height: 250px;
            }
            
            .pinata {
                font-size: 6rem;
            }
        }
        
        @media (max-width: 480px) {
            h1 { font-size: 1.8rem; letter-spacing: 2px; }
            h2 { font-size: 1.3rem; }
            
            .game-header {
                grid-template-columns: 1fr 1fr;
                padding: 10px;
                gap: 5px;
            }
            
            .game-header div {
                font-size: 1rem;
                padding: 8px 5px;
            }
            
            .progress-text {
                font-size: 1rem;
            }
            
            .card {
                height: 120px;
                padding: 15px;
            }
            
            .emoji-card { font-size: 2.5rem; }
            .word-card { font-size: 1.2rem; }
            
            .avatar { font-size: 3.5rem; }
            .color-option { width: 50px; height: 50px; margin: 5px; }
            .player-avatar { font-size: 1.2rem; }
            
            .reward-path {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .reward-step {
                margin: 5px;
                font-size: 1.5rem;
            }
            
            .character {
                font-size: 2.5rem;
            }
            
            .bonus-game-area {
                height: 200px;
            }
            
            .pinata {
                font-size: 5rem;
            }
        }
        
        @media (max-width: 360px) {
            h1 { font-size: 1.5rem; letter-spacing: 1px; }
            h2 { font-size: 1.1rem; }
            h3 { font-size: 1rem; }
            .card { height: 120px; }
            .emoji-card { font-size: 2.2rem; }
            .word-card { font-size: 1.1rem; }
            .mode-btn { min-width: 140px; padding: 12px; font-size: 1rem; }
            .avatar { font-size: 3rem; }
            .color-option { width: 45px; height: 45px; }
            .player-avatar { font-size: 1rem; }
        }
        
        .theme-green { background: radial-gradient(circle at center, #1a3a2a, #0d2a1a); }
        .theme-blue { background: radial-gradient(circle at center, #1a2a3a, #0d1b2a); }
        .theme-red { background: radial-gradient(circle at center, #3a1a1a, #2a0d0d); }
        .theme-purple { background: radial-gradient(circle at center, #3a1a3a, #2a0d2a); }
        .theme-orange { background: radial-gradient(circle at center, #3a2a1a, #2a1a0d); }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="error-notification" class="error-notification" style="display: none;"></div>
        <div id="success-notification" class="success-notification" style="display: none;"></div>
        
        <button id="logout-btn" class="logout-btn" style="display: none;">🚪 Cerrar Sesión</button>
        
        <!-- New kid-friendly elements -->
        <button id="music-control" class="music-control">🎵</button>
        <div id="character" class="character">🐉</div>
        
        <div id="start-screen" class="screen active">
            <h1>NANDOmode</h1>
            <h2>Aprende Vocabulario Español</h2>
            
            <div class="username-container">
                <h3>Selecciona o Introduce Nombre:</h3>
                <select id="user-select" aria-label="Seleccionar usuario existente">
                    <option value="">Nuevo Usuario</option>
                </select>
                <input type="text" id="username-input" placeholder="Escribe nuevo nombre..." maxlength="20" aria-label="Introducir nuevo nombre">
                <button id="save-username" aria-label="Guardar nombre y continuar">💾 Guardar & Continuar</button>
            </div>
            
            <div class="avatar-container">
                <div class="avatar" data-avatar="👾" role="button" tabindex="0" aria-label="Seleccionar avatar: Alien">👾</div>
                <div class="avatar" data-avatar="🦊" role="button" tabindex="0" aria-label="Seleccionar avatar: Zorro">🦊</div>
                <div class="avatar selected" data-avatar="🐉" role="button" tabindex="0" aria-label="Seleccionar avatar: Dragón">🐉</div>
                <div class="avatar" data-avatar="🦄" role="button" tabindex="0" aria-label="Seleccionar avatar: Unicornio">🦄</div>
                <div class="avatar" data-avatar="🤖" role="button" tabindex="0" aria-label="Seleccionar avatar: Robot">🤖</div>
                <div class="avatar" data-avatar="👻" role="button" tabindex="0" aria-label="Seleccionar avatar: Fantasma">👻</div>
                <div class="avatar" data-avatar="🐧" role="button" tabindex="0" aria-label="Seleccionar avatar: Pingüino">🐧</div>
                <div class="avatar" data-avatar="🦖" role="button" tabindex="0" aria-label="Seleccionar avatar: Dinosaurio">🦖</div>
            </div>
            
            <div class="color-picker">
                <div class="color-option selected" style="background: #3a7;" data-color="green" role="button" tabindex="0" aria-label="Seleccionar tema verde"></div>
                <div class="color-option" style="background: #47a;" data-color="blue" role="button" tabindex="0" aria-label="Seleccionar tema azul"></div>
                <div class="color-option" style="background: #a54;" data-color="red" role="button" tabindex="0" aria-label="Seleccionar tema rojo"></div>
                <div class="color-option" style="background: #a37;" data-color="purple" role="button" tabindex="0" aria-label="Seleccionar tema morado"></div>
                <div class="color-option" style="background: #ea6;" data-color="orange" role="button" tabindex="0" aria-label="Seleccionar tema naranja"></div>
            </div>
            
            <div class="btn-group">
                <button id="quick-play-btn" aria-label="Juego rápido como invitado">🎮 Juego Rápido</button>
                <button id="trophy-room-btn" aria-label="Ver sala de trofeos">🏆 Sala de Trofeos</button>
                <button id="emoji-store-btn" aria-label="Visitar tienda de emojis">🛒 Tienda de Emojis</button>
            </div>
            
            <h3>Selecciona Modo de Juego:</h3>
            <div class="btn-group">
                <button class="mode-btn easy" data-mode="easy" aria-label="Iniciar modo fácil">😊 Modo Fácil</button>
                <button class="mode-btn medium" data-mode="medium" aria-label="Iniciar modo medio">😃 Modo Medio</button>
                <button class="mode-btn hard" data-mode="hard" aria-label="Iniciar modo difícil">🤓 Modo Difícil</button>
            </div>
            
            <!-- New sticker collection preview -->
            <div class="sticker-collection">
                <div class="sticker unlocked">⭐</div>
                <div class="sticker unlocked">🎯</div>
                <div class="sticker locked">🏅</div>
                <div class="sticker locked">🏆</div>
                <div class="sticker locked">👑</div>
            </div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="progress-tracker">
                <div>Palabras: <span id="completed">0</span>/50</div>
                <div class="daily-streak" id="streak-display">
                    <span class="streak-fire">🔥</span> <span id="streak-count">0</span>
                </div>
            </div>
            
            <div class="game-header">
                <div class="player-info">
                    <span class="player-avatar" id="player-avatar">🐉</span>
                    Jugador: <span id="player-name">Invitado</span>
                </div>
                <div>Puntos: <span id="score">0</span></div>
                <div>Racha: <span id="streak">0</span></div>
                <div>Progreso: <span id="progress">0</span>/50</div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-text"><span id="percent-complete">0</span>%</div>
                    </div>
                </div>
            </div>
            
            <div class="game-board" id="game-board">
                <!-- Dynamic content based on game mode -->
            </div>
            
            <div class="btn-group">
                <button id="quit-btn" aria-label="Salir al menú principal">🏠 Salir</button>
                <button id="kid-mode-btn" aria-label="Modo niño">👶 Modo Niño</button>
            </div>
        </div>
        
        <div id="bonus-game-screen" class="screen">
            <div class="bonus-game-container">
                <h2 class="bonus-game-title" id="bonus-game-title">¡Juego Bonus!</h2>
                <p class="bonus-game-instructions" id="bonus-game-instructions">Toca la piñata para ganar puntos</p>
                <div class="bonus-game-area" id="bonus-game-area"></div>
                <div class="bonus-game-score">Puntos: <span id="bonus-score">0</span></div>
                <div class="bonus-game-timer">Tiempo: <span id="bonus-timer">30</span>s</div>
                <button id="bonus-continue-btn" class="mode-btn easy">Continuar al Juego Principal</button>
            </div>
        </div>
        
        <div id="round-complete-screen" class="screen">
            <h2>¡Bien Hecho!</h2>
            <div class="round-result" role="alert">
                Puntos de Ronda: <span id="round-score">0</span><br>
                Puntos Totales: <span id="total-score">0</span><br>
                Palabras Dominadas: <span id="progress-count">0</span>/50<br>
                Racha Actual: <span id="progress-streak">0</span>
            </div>
            <div class="trophy-container">
                <h3>Tus Recompensas</h3>
                <div id="trophy-display"></div>
                <div class="reward-path" id="reward-path-display">
                    <div class="reward-step" data-step="medal">
                        🎖️
                        <div class="reward-label">Medalla</div>
                    </div>
                    <div class="reward-step" data-step="trophy">
                        🏆
                        <div class="reward-label">Trofeo</div>
                    </div>
                    <div class="reward-step" data-step="crown">
                        👑
                        <div class="reward-label">Corona</div>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button id="next-round-btn" aria-label="Continuar a siguiente ronda">⏭️ Siguiente Ronda</button>
                <button id="quit-round-btn" aria-label="Salir al menú principal">🏠 Salir</button>
                <button id="trophy-room-btn-round" aria-label="Ver sala de trofeos">🏆 Sala de Trofeos</button>
                <button id="emoji-store-btn-round" aria-label="Visitar tienda de emojis">🛒 Tienda de Emojis</button>
            </div>
        </div>
        
        <div id="trophy-room-screen" class="screen">
            <h2>Sala de Trofeos</h2>
            <div class="trophy-container">
                <h3>Tus Logros</h3>
                <div id="trophy-list"></div>
                <h3>Tus Pegatinas</h3>
                <div class="sticker-collection" id="sticker-collection">
                    <!-- Stickers will be added here dynamically -->
                </div>
            </div>
            <div class="btn-group">
                <button id="back-to-menu-btn" aria-label="Volver al menú principal">🏠 Menú Principal</button>
            </div>
        </div>
        
        <div id="emoji-store-screen" class="screen">
            <h2>Tienda de Emojis</h2>
            <div class="emoji-store-container">
                <h3>Tus Puntos: <span id="store-points">0</span></h3>
                <div id="emoji-list"></div>
            </div>
            <div class="btn-group">
                <button id="back-to-menu-btn-store" aria-label="Volver al menú principal">🏠 Menú Principal</button>
            </div>
        </div>
        
        <div id="game-over-screen" class="screen">
            <h2>¡Felicidades!</h2>
            <div class="round-result" role="alert">
                ¡Enhorabuena <span id="final-player">Jugador</span>!<br>
                ¡Has dominado 50 palabras en español!<br>
                Puntos Finales: <span id="final-score">0</span>
            </div>
            <div class="trophy-container">
                <h3>Tus Recompensas</h3>
                <div id="final-trophy-display"></div>
                <h3>¡Nueva Pegatina Desbloqueada!</h3>
                <div class="sticker unlocked" style="font-size: 4rem;">🎉</div>
            </div>
            <div class="btn-group">
                <button id="play-again-btn" aria-label="Jugar de nuevo">🔄 Jugar Otra Vez</button>
                <button id="main-menu-btn" aria-label="Volver al menú principal">🏠 Menú Principal</button>
            </div>
        </div>
    </div>

    <script>
        // Game state variables
        const isMobile = window.innerWidth <= 768;
        let isProcessingClick = false;
        let lastTTSTime = 0;
        const ttsDebounce = 1000;
        const milestones = [5, 10, 15, 20, 25, 30, 35, 40, 45, 50];
        let backgroundMusic = null;
        let isMusicPlaying = false;
        let roundsPlayed = 0;
        let isKidMode = false;
        
        // Bonus games
        const BONUS_GAMES = [
            { 
                name: "Piñata Party", 
                instructions: "¡Golpea la piñata para ganar dulces y puntos!", 
                setup: setupPinataGame 
            },
            { 
                name: "Corrida de Toros", 
                instructions: "¡Esquiva al toro para ganar puntos!", 
                setup: setupBullRunGame 
            },
            { 
                name: "Flamenco Fiesta", 
                instructions: "¡Toca al bailarín para atrapar las castañuelas!", 
                setup: setupFlamencoGame 
            },
            { 
                name: "Fútbol Español", 
                instructions: "¡Patea el balón para marcar goles!", 
                setup: setupSoccerGame 
            },
            { 
                name: "Tapas Time", 
                instructions: "¡Atrapa las tapas que caen para ganar puntos!", 
                setup: setupTapasGame 
            },
            { 
                name: "Fiesta Española", 
                instructions: "¡Toca los objetos de la fiesta para ganar puntos!", 
                setup: setupFiestaGame 
            },
            { 
                name: "Gaudi Mosaico", 
                instructions: "¡Toca los mosaicos de colores para ganar puntos!", 
                setup: setupGaudiGame 
            },
            { 
                name: "Churros Challenge", 
                instructions: "¡Atrapa los churros que caen para ganar puntos!", 
                setup: setupChurroGame 
            },
            { 
                name: "Maracas Madness", 
                instructions: "¡Agita las maracas para ganar puntos!", 
                setup: setupMaracaGame 
            },
            { 
                name: "Don Quixote", 
                instructions: "¡Toca a Don Quijote para detener los molinos!", 
                setup: setupDonQuixoteGame 
            }
        ];

        // Default vocabulary - will be replaced if vocab.js loads
        const defaultVocab = [
            { word: 'gato', emoji: '😺', type: 'noun' },
            { word: 'perro', emoji: '🐶', type: 'noun' },
            { word: 'sol', emoji: '☀️', type: 'noun' },
            { word: 'luna', emoji: '🌙', type: 'noun' },
            { word: 'casa', emoji: '🏠', type: 'noun' },
            { word: 'árbol', emoji: '🌳', type: 'noun' },
            { word: 'agua', emoji: '💧', type: 'noun' },
            { word: 'fuego', emoji: '🔥', type: 'noun' },
            { word: 'libro', emoji: '📖', type: 'noun' },
            { word: 'manzana', emoji: '🍎', type: 'noun' },
            { word: 'correr', emoji: '🏃', type: 'verb' },
            { word: 'saltar', emoji: '🦘', type: 'verb' },
            { word: 'comer', emoji: '🍽️', type: 'verb' },
            { word: 'beber', emoji: '🥛', type: 'verb' },
            { word: 'dormir', emoji: '😴', type: 'verb' },
            { word: 'grande', emoji: '🐘', type: 'adjective' },
            { word: 'pequeño', emoji: '🐜', type: 'adjective' },
            { word: 'feliz', emoji: '😊', type: 'adjective' },
            { word: 'triste', emoji: '😢', type: 'adjective' },
            { word: 'rápido', emoji: '⚡', type: 'adjective' }
        ];

        // Main game state
        const gameState = {
            currentScreen: 'start',
            player: {
                name: 'Invitado',
                avatar: '🐉',
                theme: 'green',
                emoji: '',
                points: 0,
                purchasedEmojis: [],
                rewards: { easy: { medals: 0, trophies: 0, crowns: 0 }, medium: { medals: 0, trophies: 0, crowns: 0 }, hard: { medals: 0, trophies: 0, crowns: 0 } },
                dailyStreak: 0,
                lastPlayedDate: null,
                weeklyProgress: 0,
                unlockedStickers: ['⭐', '🎯']
            },
            mode: '',
            streak: 0,
            completedWords: 0,
            wordProgress: {},
            currentRound: { 
                pairs: [], 
                leftColumn: [], 
                rightColumn: [], 
                selectedLeft: null, 
                selectedRight: null, 
                matchedPairs: [], 
                roundPoints: 0 
            },
            leaderboard: []
        };

        function showSuccess(message) {
            const notification = document.getElementById('success-notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            const notification = document.getElementById('error-notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'milestone-notification';
            notification.textContent = message;
            document.getElementById('game-container').appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Screen elements
        const screens = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            bonus: document.getElementById('bonus-game-screen'),
            roundComplete: document.getElementById('round-complete-screen'),
            trophyRoom: document.getElementById('trophy-room-screen'),
            emojiStore: document.getElementById('emoji-store-screen'),
            gameOver: document.getElementById('game-over-screen')
        };

        // Initialize the game
        window.addEventListener('DOMContentLoaded', initGame);

        function initGame() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                console.error("LocalStorage not available:", e);
                showError("La configuración de tu navegador impide guardar el progreso. Por favor, habilita localStorage.");
                return;
            }
            
            // Try to load vocab.js
            loadVocab().then(vocab => {
                if (!vocab || vocab.length === 0) {
                    console.warn("vocab.js not loaded, using default vocab");
                    showError("¡Vaya! La lista de palabras no se cargó. Usando palabras de respaldo.");
                }
                
                try {
                    const savedLeaderboard = localStorage.getItem('nandomodeLeaderboard');
                    if (savedLeaderboard) {
                        gameState.leaderboard = JSON.parse(savedLeaderboard);
                    }
                } catch (e) {
                    console.warn("Error loading leaderboard:", e);
                    showError("No se pudo cargar el marcador. ¡Empezando de nuevo!");
                }
                
                // Initialize background music
                initBackgroundMusic();
                
                // Setup character interaction
                setupCharacter();
                
                populateUserSelect();
                loadPlayerProgress();
                setupEventListeners();
                updatePlayerUI();
                updateProgressBar();
                updateStreakDisplay();
                updateRewardPath();
                updateLogoutButton();
                updateStickerCollection();
            });
        }

        function loadVocab() {
            return new Promise((resolve) => {
                // Check if vocab.js is loaded
                if (window.vocab && Array.isArray(window.vocab)) {
                    resolve(window.vocab);
                } else {
                    // Try to load vocab.js
                    const script = document.createElement('script');
                    script.src = 'vocab.js';
                    script.onload = () => {
                        resolve(window.vocab || defaultVocab);
                    };
                    script.onerror = () => {
                        console.warn("Failed to load vocab.js");
                        resolve(defaultVocab);
                    };
                    document.head.appendChild(script);
                }
            });
        }

        function initBackgroundMusic() {
            try {
                // Create audio context
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioContext();
                
                // Create background music (simple loop)
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.value = 440;
                gainNode.gain.value = 0.1;
                
                backgroundMusic = {
                    oscillator: oscillator,
                    gainNode: gainNode,
                    context: audioContext
                };
                
                // Setup music control button
                document.getElementById('music-control').addEventListener('click', toggleMusic);
                
            } catch (e) {
                console.warn("Could not initialize audio:", e);
                document.getElementById('music-control').style.display = 'none';
            }
        }

        function toggleMusic() {
            if (!backgroundMusic) return;
            
            if (isMusicPlaying) {
                backgroundMusic.oscillator.stop();
                document.getElementById('music-control').textContent = '🔇';
                isMusicPlaying = false;
            } else {
                backgroundMusic.oscillator = backgroundMusic.context.createOscillator();
                backgroundMusic.oscillator.connect(backgroundMusic.gainNode);
                backgroundMusic.oscillator.type = 'sine';
                backgroundMusic.oscillator.frequency.value = 440;
                backgroundMusic.oscillator.start();
                document.getElementById('music-control').textContent = '🎵';
                isMusicPlaying = true;
            }
        }

        function setupCharacter() {
            const character = document.getElementById('character');
            character.addEventListener('click', () => {
                const messages = [
                    "¡Vamos a aprender!",
                    "¡Tú puedes!",
                    "¡Sigue así!",
                    "¡Eres increíble!",
                    "¡Qué bien lo haces!"
                ];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                showNotification(randomMessage);
            });
        }

        function populateUserSelect() {
            const userSelect = document.getElementById('user-select');
            userSelect.innerHTML = '<option value="">Nuevo Usuario</option>';
            
            const keys = Object.keys(localStorage);
            const users = [];
            keys.forEach(key => {
                if (key.startsWith('nandomodeProgress_')) {
                    const username = key.replace('nandomodeProgress_', '');
                    users.push(username);
                }
            });
            
            users.sort();
            
            users.forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                userSelect.appendChild(option);
            });
            
            const savedName = localStorage.getItem('nandomodeCurrentPlayer');
            if (savedName && users.includes(savedName)) {
                userSelect.value = savedName;
                loadSelectedUser();
            }
        }

        function setupEventListeners() {
            document.getElementById('save-username').addEventListener('click', saveUsername);
            document.getElementById('user-select').addEventListener('change', loadSelectedUser);
            document.getElementById('quick-play-btn').addEventListener('click', quickPlay);
            document.getElementById('trophy-room-btn').addEventListener('click', showTrophyRoom);
            document.getElementById('emoji-store-btn').addEventListener('click', showEmojiStore);
            document.getElementById('trophy-room-btn-round').addEventListener('click', showTrophyRoom);
            document.getElementById('emoji-store-btn-round').addEventListener('click', showEmojiStore);
            document.getElementById('back-to-menu-btn').addEventListener('click', quitToMainMenu);
            document.getElementById('back-to-menu-btn-store').addEventListener('click', quitToMainMenu);
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            document.querySelectorAll('.avatar').forEach(avatar => {
                avatar.addEventListener('click', selectAvatar.bind(null, avatar));
                avatar.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') selectAvatar(avatar);
                });
            });

            document.querySelectorAll('.color-option').forEach(color => {
                color.addEventListener('click', selectColor.bind(null, color));
                color.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') selectColor(color);
                });
            });

            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    gameState.mode = btn.dataset.mode;
                    startNewGame();
                });
            });

            document.getElementById('quit-btn').addEventListener('click', quitToMainMenu);
            document.getElementById('next-round-btn').addEventListener('click', startNewRound);
            document.getElementById('quit-round-btn').addEventListener('click', quitToMainMenu);
            document.getElementById('play-again-btn').addEventListener('click', startNewGame);
            document.getElementById('main-menu-btn').addEventListener('click', quitToMainMenu);
            document.getElementById('kid-mode-btn').addEventListener('click', toggleKidMode);
            document.getElementById('bonus-continue-btn').addEventListener('click', startNewRound);
        }

        function toggleKidMode() {
            isKidMode = !isKidMode;
            const gameContainer = document.getElementById('game-container');
            const kidModeBtn = document.getElementById('kid-mode-btn');
            
            if (isKidMode) {
                gameContainer.classList.add('kid-mode');
                kidModeBtn.textContent = '👶 Modo Normal';
                showSuccess("Modo Niño Activado - ¡Tarjetas más grandes!");
            } else {
                gameContainer.classList.remove('kid-mode');
                kidModeBtn.textContent = '👶 Modo Niño';
                showSuccess("Modo Niño Desactivado");
            }
            
            updateGameUI();
        }

        function selectAvatar(avatar) {
            document.querySelectorAll('.avatar').forEach(a => a.classList.remove('selected'));
            avatar.classList.add('selected');
            gameState.player.avatar = avatar.dataset.avatar;
            updatePlayerUI();
            document.getElementById('character').textContent = avatar.dataset.avatar;
        }

        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
            color.classList.add('selected');
            gameState.player.theme = color.dataset.color;
            updatePlayerUI();
        }

        function updatePlayerUI() {
            const displayName = gameState.player.emoji ? `${gameState.player.name} ${gameState.player.emoji}` : gameState.player.name;
            document.getElementById('player-name').textContent = displayName;
            document.getElementById('final-player').textContent = displayName;
            const avatarElement = document.getElementById('player-avatar');
            if (avatarElement) avatarElement.textContent = gameState.player.avatar;
            
            // Update the theme
            document.getElementById('game-container').className = `theme-${gameState.player.theme}`;
        }

        function updateLogoutButton() {
            const logoutBtn = document.getElementById('logout-btn');
            if (gameState.player.name !== 'Invitado') {
                logoutBtn.style.display = 'block';
            } else {
                logoutBtn.style.display = 'none';
            }
        }

        function updateStreakDisplay() {
            const today = new Date().toDateString();
            if (gameState.player.lastPlayedDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (gameState.player.lastPlayedDate === yesterday.toDateString()) {
                    gameState.player.dailyStreak++;
                    showSuccess(`¡Racha extendida a ${gameState.player.dailyStreak} días!`);
                } else if (gameState.player.lastPlayedDate !== today) {
                    gameState.player.dailyStreak = 1;
                    showSuccess('¡Nueva racha comenzada!');
                }
                gameState.player.lastPlayedDate = today;
                savePlayerProgress();
            }
            
            document.getElementById('streak-count').textContent = gameState.player.dailyStreak;
        }

        function updateRewardPath() {
            const modeRewards = gameState.player.rewards[gameState.mode] || { medals: 0, trophies: 0, crowns: 0 };
            const steps = document.querySelectorAll('.reward-step');
            
            steps.forEach(step => {
                step.classList.remove('earned', 'next');
                const stepType = step.dataset.step;
                
                if (stepType === 'medal' && modeRewards.medals > 0) {
                    step.classList.add('earned');
                } else if (stepType === 'trophy' && modeRewards.trophies > 0) {
                    step.classList.add('earned');
                } else if (stepType === 'crown' && modeRewards.crowns > 0) {
                    step.classList.add('earned');
                }
            });
            
            if (modeRewards.medals === 0) {
                document.querySelector('.reward-step[data-step="medal"]').classList.add('next');
            } else if (modeRewards.trophies === 0) {
                document.querySelector('.reward-step[data-step="trophy"]').classList.add('next');
            } else if (modeRewards.crowns === 0) {
                document.querySelector('.reward-step[data-step="crown"]').classList.add('next');
            }
        }

        function updateStickerCollection() {
            const collection = document.getElementById('sticker-collection');
            if (!collection) return;
            
            collection.innerHTML = '';
            
            const stickers = [
                { emoji: '⭐', unlocked: true, points: 0 },
                { emoji: '🎯', unlocked: true, points: 0 },
                { emoji: '🏅', unlocked: false, points: 100 },
                { emoji: '🏆', unlocked: false, points: 500 },
                { emoji: '👑', unlocked: false, points: 1000 },
                { emoji: '🎖️', unlocked: false, points: 1500 },
                { emoji: '🎉', unlocked: false, points: 2000 },
                { emoji: '🏅', unlocked: false, points: 2500 },
                { emoji: '🏆', unlocked: false, points: 3000 },
                { emoji: '👑', unlocked: false, points: 5000 }
            ];
            
            stickers.forEach(sticker => {
                const div = document.createElement('div');
                div.className = `sticker ${gameState.player.unlockedStickers.includes(sticker.emoji) ? 'unlocked' : 'locked'}`;
                div.textContent = sticker.emoji;
                div.title = gameState.player.unlockedStickers.includes(sticker.emoji) ? 
                    `Pegatina desbloqueada` : 
                    `Desbloquea con ${sticker.points} puntos`;
                collection.appendChild(div);
            });
        }

        function loadSelectedUser() {
            const userSelect = document.getElementById('user-select');
            const username = userSelect.value;
            const usernameInput = document.getElementById('username-input');
            
            if (username) {
                try {
                    const savedData = localStorage.getItem(`nandomodeProgress_${username}`);
                    if (savedData) {
                        const playerData = JSON.parse(savedData);
                        
                        // Always show the input field
                        usernameInput.style.display = 'block';
                        usernameInput.placeholder = `¡Bienvenido de nuevo, ${username}!`;
                        
                        // Update game state
                        gameState.player = {
                            name: username,
                            avatar: playerData.avatar || '🐉',
                            theme: playerData.theme || 'green',
                            emoji: playerData.emoji || '',
                            points: playerData.points || 0,
                            purchasedEmojis: playerData.purchasedEmojis || [],
                            rewards: playerData.rewards || { 
                                easy: { medals: 0, trophies: 0, crowns: 0 }, 
                                medium: { medals: 0, trophies: 0, crowns: 0 }, 
                                hard: { medals: 0, trophies: 0, crowns: 0 } 
                            },
                            dailyStreak: playerData.dailyStreak || 0,
                            lastPlayedDate: playerData.lastPlayedDate || null,
                            weeklyProgress: playerData.weeklyProgress || 0,
                            unlockedStickers: playerData.unlockedStickers || ['⭐', '🎯']
                        };
                        
                        gameState.streak = playerData.streak || 0;
                        gameState.completedWords = playerData.completedWords || 0;
                        gameState.wordProgress = playerData.wordProgress || {};
                        
                        // Update UI
                        document.querySelectorAll('.avatar').forEach(avatar => {
                            avatar.classList.toggle('selected', avatar.dataset.avatar === gameState.player.avatar);
                        });
                        
                        document.querySelectorAll('.color-option').forEach(color => {
                            color.classList.toggle('selected', color.dataset.color === gameState.player.theme);
                        });
                        
                        updatePlayerUI();
                        updateLogoutButton();
                        updateStickerCollection();
                        document.getElementById('character').textContent = gameState.player.avatar;
                        showSuccess(`¡Bienvenido de nuevo, ${username}!`);
                        return;
                    }
                } catch (e) {
                    console.error("Error loading user data:", e);
                    showError("Error al cargar datos de usuario. Empezando de nuevo.");
                }
            }
            
            // Default to showing input field for new users
            usernameInput.style.display = 'block';
            usernameInput.placeholder = 'Escribe nuevo nombre...';
            gameState.player = {
                name: 'Invitado',
                avatar: '🐉',
                theme: 'green',
                emoji: '',
                points: 0,
                purchasedEmojis: [],
                rewards: { 
                    easy: { medals: 0, trophies: 0, crowns: 0 }, 
                    medium: { medals: 0, trophies: 0, crowns: 0 }, 
                    hard: { medals: 0, trophies: 0, crowns: 0 } 
                },
                dailyStreak: 0,
                lastPlayedDate: null,
                weeklyProgress: 0,
                unlockedStickers: ['⭐', '🎯']
            };
            gameState.streak = 0;
            gameState.completedWords = 0;
            gameState.wordProgress = {};
            updatePlayerUI();
            updateLogoutButton();
            updateStickerCollection();
            document.getElementById('character').textContent = '🐉';
        }

        function saveUsername() {
            const usernameInput = document.getElementById('username-input');
            const username = usernameInput.value.trim();
            
            if (!username) {
                showError("Por favor introduce un nombre de usuario");
                return;
            }
            
            // Always show the input field
            usernameInput.style.display = 'block';
            
            // Check if this is a new user or existing user
            const isNewUser = !gameState.leaderboard.some(user => user.name === username);
            
            if (isNewUser) {
                // Initialize new user data
                gameState.player = {
                    name: username,
                    avatar: gameState.player.avatar || '🐉',
                    theme: gameState.player.theme || 'green',
                    emoji: '',
                    points: 0,
                    purchasedEmojis: [],
                    rewards: { 
                        easy: { medals: 0, trophies: 0, crowns: 0 }, 
                        medium: { medals: 0, trophies: 0, crowns: 0 }, 
                        hard: { medals: 0, trophies: 0, crowns: 0 } 
                    },
                    dailyStreak: 0,
                    lastPlayedDate: null,
                    weeklyProgress: 0,
                    unlockedStickers: ['⭐', '🎯']
                };
                
                gameState.streak = 0;
                gameState.completedWords = 0;
                gameState.wordProgress = {};
            }
            
            localStorage.setItem('nandomodeCurrentPlayer', username);
            savePlayerProgress();
            
            updatePlayerUI();
            updateLogoutButton();
            updateStickerCollection();
            
            usernameInput.value = '';
            usernameInput.placeholder = isNewUser ? `¡Bienvenido, ${username}!` : `¡Bienvenido de nuevo, ${username}!`;
            
            const btn = document.getElementById('save-username');
            btn.textContent = isNewUser ? '✓ ¡Nuevo Usuario Creado!' : '✓ ¡Usuario Cargado!';
            setTimeout(() => btn.textContent = '💾 Guardar & Continuar', 1500);
            
            populateUserSelect();
            document.getElementById('user-select').value = username;
            
            showSuccess(isNewUser ? `¡Nueva cuenta creada para ${username}!` : `¡Bienvenido de nuevo ${username}!`);
        }

        function quickPlay() {
            // Only set guest mode if no user is currently logged in
            if (gameState.player.name === 'Invitado') {
                gameState.player = {
                    name: 'Invitado',
                    avatar: '🐉',
                    theme: 'green',
                    emoji: '',
                    points: 0,
                    purchasedEmojis: [],
                    rewards: { 
                        easy: { medals: 0, trophies: 0, crowns: 0 }, 
                        medium: { medals: 0, trophies: 0, crowns: 0 }, 
                        hard: { medals: 0, trophies: 0, crowns: 0 } 
                    },
                    dailyStreak: 0,
                    lastPlayedDate: null,
                    weeklyProgress: 0,
                    unlockedStickers: ['⭐', '🎯']
                };
                gameState.streak = 0;
                gameState.completedWords = 0;
                gameState.wordProgress = {};
                
                updatePlayerUI();
                updateLogoutButton();
                updateStickerCollection();
                showSuccess("Jugando como Invitado. El progreso no se guardará.");
            }
            showScreen('start');
        }

        function logout() {
            gameState.player = {
                name: 'Invitado',
                avatar: '🐉',
                theme: 'green',
                emoji: '',
                points: 0,
                purchasedEmojis: [],
                rewards: { 
                    easy: { medals: 0, trophies: 0, crowns: 0 }, 
                    medium: { medals: 0, trophies: 0, crowns: 0 }, 
                    hard: { medals: 0, trophies: 0, crowns: 0 } 
                },
                dailyStreak: 0,
                lastPlayedDate: null,
                weeklyProgress: 0,
                unlockedStickers: ['⭐', '🎯']
            };
            gameState.streak = 0;
            gameState.completedWords = 0;
            gameState.wordProgress = {};
            
            localStorage.removeItem('nandomodeCurrentPlayer');
            
            updatePlayerUI();
            updateLogoutButton();
            updateStickerCollection();
            populateUserSelect();
            
            document.getElementById('username-input').style.display = 'block';
            document.getElementById('username-input').placeholder = 'Escribe nuevo nombre...';
            document.getElementById('user-select').value = '';
            document.getElementById('character').textContent = '🐉';
            
            showSuccess("Sesión cerrada correctamente");
            showScreen('start');
        }

        function savePlayerProgress() {
            if (gameState.player.name === 'Invitado') {
                console.log('Not saving progress for Guest user');
                return;
            }
            
            try {
                const playerData = {
                    name: gameState.player.name,
                    avatar: gameState.player.avatar,
                    theme: gameState.player.theme,
                    emoji: gameState.player.emoji,
                    points: gameState.player.points,
                    purchasedEmojis: gameState.player.purchasedEmojis,
                    rewards: gameState.player.rewards,
                    dailyStreak: gameState.player.dailyStreak,
                    lastPlayedDate: gameState.player.lastPlayedDate,
                    weeklyProgress: gameState.player.weeklyProgress,
                    wordProgress: gameState.wordProgress,
                    completedWords: gameState.completedWords,
                    streak: gameState.streak,
                    unlockedStickers: gameState.player.unlockedStickers,
                    lastActive: new Date().toISOString()
                };
                
                localStorage.setItem(`nandomodeProgress_${gameState.player.name}`, JSON.stringify(playerData));
                localStorage.setItem('nandomodeCurrentPlayer', gameState.player.name);
                console.log('Progress saved for:', gameState.player.name);
            } catch (e) {
                console.error("Error saving player progress:", e);
                showError("No se pudo guardar el progreso. ¡Inténtalo de nuevo!");
            }
        }

        function loadPlayerProgress() {
            try {
                const savedName = localStorage.getItem('nandomodeCurrentPlayer');
                if (savedName) {
                    const savedData = localStorage.getItem(`nandomodeProgress_${savedName}`);
                    if (savedData) {
                        const playerData = JSON.parse(savedData);
                        
                        gameState.player = {
                            name: savedName,
                            avatar: playerData.avatar || '🐉',
                            theme: playerData.theme || 'green',
                            emoji: playerData.emoji || '',
                            points: playerData.points || 0,
                            purchasedEmojis: playerData.purchasedEmojis || [],
                            rewards: playerData.rewards || { 
                                easy: { medals: 0, trophies: 0, crowns: 0 }, 
                                medium: { medals: 0, trophies: 0, crowns: 0 }, 
                                hard: { medals: 0, trophies: 0, crowns: 0 } 
                            },
                            dailyStreak: playerData.dailyStreak || 0,
                            lastPlayedDate: playerData.lastPlayedDate || null,
                            weeklyProgress: playerData.weeklyProgress || 0,
                            unlockedStickers: playerData.unlockedStickers || ['⭐', '🎯']
                        };
                        
                        gameState.streak = playerData.streak || 0;
                        gameState.completedWords = playerData.completedWords || 0;
                        gameState.wordProgress = playerData.wordProgress || {};
                        
                        document.getElementById('username-input').placeholder = `¡Bienvenido de nuevo, ${gameState.player.name}!`;
                        document.querySelectorAll('.avatar').forEach(avatar => {
                            avatar.classList.toggle('selected', avatar.dataset.avatar === gameState.player.avatar);
                        });
                        document.querySelectorAll('.color-option').forEach(color => {
                            color.classList.toggle('selected', color.dataset.color === gameState.player.theme);
                        });
                        
                        updatePlayerUI();
                        updateLogoutButton();
                        updateStickerCollection();
                        return;
                    }
                }
            } catch (e) {
                console.warn("Error loading player progress:", e);
                showError("No se pudo cargar tu progreso. ¡Empezando de nuevo!");
            }
            
            gameState.player = {
                name: 'Invitado',
                avatar: '🐉',
                theme: 'green',
                emoji: '',
                points: 0,
                purchasedEmojis: [],
                rewards: { 
                    easy: { medals: 0, trophies: 0, crowns: 0 }, 
                    medium: { medals: 0, trophies: 0, crowns: 0 }, 
                    hard: { medals: 0, trophies: 0, crowns: 0 } 
                },
                dailyStreak: 0,
                lastPlayedDate: null,
                weeklyProgress: 0,
                unlockedStickers: ['⭐', '🎯']
            };
            gameState.streak = 0;
            gameState.completedWords = 0;
            gameState.wordProgress = {};
            
            updatePlayerUI();
            updateLogoutButton();
            updateStickerCollection();
            document.getElementById('character').textContent = '🐉';
        }

        function startNewGame() {
            document.getElementById('game-container').className = `theme-${gameState.player.theme}`;
            startNewRound();
            savePlayerProgress();
            updateStreakDisplay();
        }

        function startNewRound() {
            roundsPlayed++;
            
            // Check if we should show a bonus game (every 3 rounds)
            if (roundsPlayed > 0 && roundsPlayed % 3 === 0) {
                showBonusGame();
                return;
            }
            
            setupClassicMode();
            showScreen('game');
        }

        function showBonusGame() {
            const randomGame = BONUS_GAMES[Math.floor(Math.random() * BONUS_GAMES.length)];
            document.getElementById('bonus-game-title').textContent = randomGame.name;
            document.getElementById('bonus-game-instructions').textContent = randomGame.instructions;
            document.getElementById('bonus-score').textContent = '0';
            document.getElementById('bonus-timer').textContent = '30';
            
            // Clear previous game
            const gameArea = document.getElementById('bonus-game-area');
            gameArea.innerHTML = '';
            
            // Setup the new game
            randomGame.setup();
            
            showScreen('bonus');
        }

        function setupPinataGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create piñata
            const pinata = document.createElement('div');
            pinata.className = 'pinata';
            pinata.textContent = '🪅';
            pinata.addEventListener('click', () => {
                if (!gameActive) return;
                
                // Add hit animation
                pinata.classList.add('pinata-hit');
                setTimeout(() => pinata.classList.remove('pinata-hit'), 300);
                
                // Add score
                score += 5;
                document.getElementById('bonus-score').textContent = score;
                
                // Create falling candies
                for (let i = 0; i < 5; i++) {
                    const candy = document.createElement('div');
                    candy.className = 'candy';
                    candy.textContent = '🍬';
                    candy.style.left = `${Math.random() * 80 + 10}%`;
                    candy.style.animationDuration = `${Math.random() * 0.5 + 0.5}s`;
                    gameArea.appendChild(candy);
                    
                    setTimeout(() => {
                        candy.remove();
                    }, 1000);
                }
            });
            
            gameArea.appendChild(pinata);
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function setupBullRunGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create matador (player)
            const matador = document.createElement('div');
            matador.className = 'matador';
            matador.textContent = '🕴️';
            matador.addEventListener('click', () => {
                if (!gameActive) return;
                
                // Jump animation
                matador.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    matador.style.transform = 'translateY(0)';
                }, 300);
            });
            
            gameArea.appendChild(matador);
            
            // Bull spawning
            const bullSpawn = setInterval(() => {
                if (!gameActive) {
                    clearInterval(bullSpawn);
                    return;
                }
                
                const bull = document.createElement('div');
                bull.className = 'bull';
                bull.textContent = '🐂';
                
                bull.addEventListener('animationend', () => {
                    if (gameActive) {
                        score += 10;
                        document.getElementById('bonus-score').textContent = score;
                    }
                    bull.remove();
                });
                
                gameArea.appendChild(bull);
            }, 2000);
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    clearInterval(bullSpawn);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function setupFlamencoGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create flamenco dancer
            const dancer = document.createElement('div');
            dancer.className = 'flamenco-dancer';
            dancer.textContent = '💃';
            dancer.addEventListener('click', () => {
                if (!gameActive) return;
                
                // Create castanets
                for (let i = 0; i < 3; i++) {
                    const castanet = document.createElement('div');
                    castanet.className = 'castanet';
                    castanet.textContent = '🎵';
                    castanet.style.left = `${Math.random() * 80 + 10}%`;
                    castanet.style.animationDuration = `${Math.random() * 0.5 + 0.5}s`;
                    
                    castanet.addEventListener('click', (e) => {
                        if (!gameActive) return;
                        e.stopPropagation();
                        score += 5;
                        document.getElementById('bonus-score').textContent = score;
                        castanet.remove();
                    });
                    
                    gameArea.appendChild(castanet);
                    
                    setTimeout(() => {
                        castanet.remove();
                    }, 1000);
                }
            });
            
            gameArea.appendChild(dancer);
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function setupSoccerGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create goal
            const goal = document.createElement('div');
            goal.className = 'soccer-goal';
            goal.textContent = '🥅';
            gameArea.appendChild(goal);
            
            // Create ball
            const ball = document.createElement('div');
            ball.className = 'soccer-ball';
            ball.textContent = '⚽';
            ball.addEventListener('click', () => {
                if (!gameActive) return;
                
                // Kick animation
                ball.style.animation = 'none';
                void ball.offsetWidth; // Trigger reflow
                ball.style.animation = 'soccerKick 0.5s forwards';
                
                setTimeout(() => {
                    score += 10;
                    document.getElementById('bonus-score').textContent = score;
                    ball.style.animation = 'soccerKick 1s infinite alternate';
                }, 500);
            });
            
            gameArea.appendChild(ball);
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function setupTapasGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create plate
            const plate = document.createElement('div');
            plate.className = 'tapas-plate';
            plate.textContent = '🍽️';
            gameArea.appendChild(plate);
            
            // Tapas falling
            const tapasSpawn = setInterval(() => {
                if (!gameActive) {
                    clearInterval(tapasSpawn);
                    return;
                }
                
                const tapas = document.createElement('div');
                tapas.className = 'tapas-item';
                tapas.textContent = ['🍤', '🍖', '🧀', '🥖', '🍅'][Math.floor(Math.random() * 5)];
                tapas.style.left = `${Math.random() * 80 + 10}%`;
                tapas.style.animationDuration = `${Math.random() * 1 + 1}s`;
                
                tapas.addEventListener('click', () => {
                    if (!gameActive) return;
                    score += 5;
                    document.getElementById('bonus-score').textContent = score;
                    tapas.remove();
                });
                
                gameArea.appendChild(tapas);
                
                setTimeout(() => {
                    tapas.remove();
                }, 2000);
            }, 1000);
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    clearInterval(tapasSpawn);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function setupFiestaGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create fiesta items
            const fiestaItems = ['🎉', '🎊', '🎈', '🪅', '🥁', '🎪'];
            
            fiestaItems.forEach((item, index) => {
                const fiestaItem = document.createElement('div');
                fiestaItem.className = 'fiesta-item';
                fiestaItem.textContent = item;
                fiestaItem.style.left = `${Math.random() * 80 + 10}%`;
                fiestaItem.style.top = `${Math.random() * 70 + 10}%`;
                fiestaItem.style.animationDelay = `${index * 0.5}s`;
                
                fiestaItem.addEventListener('click', () => {
                    if (!gameActive) return;
                    score += 5;
                    document.getElementById('bonus-score').textContent = score;
                    
                    // Replace with new position
                    fiestaItem.style.left = `${Math.random() * 80 + 10}%`;
                    fiestaItem.style.top = `${Math.random() * 70 + 10}%`;
                });
                
                gameArea.appendChild(fiestaItem);
            });
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function setupGaudiGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create mosaic tiles
            for (let i = 0; i < 20; i++) {
                const tile = document.createElement('div');
                tile.className = 'gaudi-tile';
                tile.style.left = `${Math.random() * 80 + 10}%`;
                tile.style.top = `${Math.random() * 70 + 10}%`;
                
                tile.addEventListener('click', () => {
                    if (!gameActive) return;
                    score += 5;
                    document.getElementById('bonus-score').textContent = score;
                    
                    // Change color
                    tile.style.background = `linear-gradient(45deg, #${Math.floor(Math.random()*16777215).toString(16)}, #${Math.floor(Math.random()*16777215).toString(16)})`;
                });
                
                gameArea.appendChild(tile);
            }
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function setupChurroGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create churros
            const churroSpawn = setInterval(() => {
                if (!gameActive) {
                    clearInterval(churroSpawn);
                    return;
                }
                
                const churro = document.createElement('div');
                churro.className = 'churro';
                churro.textContent = '🥨';
                churro.style.left = `${Math.random() * 80 + 10}%`;
                churro.style.top = `${Math.random() * 70 + 10}%`;
                churro.style.animationDelay = `${Math.random() * 2}s`;
                
                churro.addEventListener('click', () => {
                    if (!gameActive) return;
                    score += 5;
                    document.getElementById('bonus-score').textContent = score;
                    churro.remove();
                });
                
                gameArea.appendChild(churro);
                
                setTimeout(() => {
                    churro.remove();
                }, 3000);
            }, 1000);
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    clearInterval(churroSpawn);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function setupMaracaGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create maracas
            const maraca1 = document.createElement('div');
            maraca1.className = 'maraca';
            maraca1.textContent = '🥁';
            maraca1.style.left = '30%';
            maraca1.style.top = '50%';
            gameArea.appendChild(maraca1);
            
            const maraca2 = document.createElement('div');
            maraca2.className = 'maraca';
            maraca2.textContent = '🥁';
            maraca2.style.left = '70%';
            maraca2.style.top = '50%';
            gameArea.appendChild(maraca2);
            
            // Click handler
            function handleMaracaClick() {
                if (!gameActive) return;
                score += 2;
                document.getElementById('bonus-score').textContent = score;
            }
            
            maraca1.addEventListener('click', handleMaracaClick);
            maraca2.addEventListener('click', handleMaracaClick);
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function setupDonQuixoteGame() {
            const gameArea = document.getElementById('bonus-game-area');
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;
            
            // Create windmill
            const windmill = document.createElement('div');
            windmill.className = 'windmill';
            windmill.textContent = '🎡';
            gameArea.appendChild(windmill);
            
            // Create Don Quixote
            const donQuixote = document.createElement('div');
            donQuixote.className = 'don-quixote';
            donQuixote.textContent = '🤺';
            donQuixote.addEventListener('click', () => {
                if (!gameActive) return;
                
                // Attack animation
                donQuixote.style.transform = 'translateX(-50%) translateY(-20px)';
                setTimeout(() => {
                    donQuixote.style.transform = 'translateX(-50%)';
                }, 300);
                
                score += 10;
                document.getElementById('bonus-score').textContent = score;
            });
            
            gameArea.appendChild(donQuixote);
            
            // Game timer
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('bonus-timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(timer);
                    endBonusGame(score);
                }
            }, 1000);
        }

        function endBonusGame(score) {
            gameState.player.points += score;
            showNotification(`¡Ganaste ${score} puntos en el juego bonus!`);
            startNewRound();
        }

        function generateRoundData() {
            gameState.currentRound = {
                pairs: [],
                leftColumn: [],
                rightColumn: [],
                selectedLeft: null,
                selectedRight: null,
                matchedPairs: [],
                roundPoints: 0
            };
            
            const vocab = window.vocab && window.vocab.length > 0 ? window.vocab : defaultVocab;
            const newWords = getNewWords(3);
            const reviewWords = getReviewWords(2);
            const roundWords = shuffleArray([...newWords, ...reviewWords]);
            
            console.log(`Round words: ${roundWords.join(', ')}`);
            
            roundWords.forEach(word => {
                const vocabItem = vocab.find(item => item.word === word);
                if (vocabItem) {
                    const pairId = sanitizePairId(word);
                    gameState.currentRound.pairs.push({
                        pairId,
                        word: vocabItem.word,
                        emoji: vocabItem.emoji,
                        type: vocabItem.type
                    });
                }
            });
            
            gameState.currentRound.pairs = shuffleArray([...gameState.currentRound.pairs]);
            
            const emojis = gameState.currentRound.pairs.map(pair => ({
                pairId: pair.pairId,
                type: 'emoji',
                value: pair.emoji
            }));
            const words = gameState.currentRound.pairs.map(pair => ({
                pairId: pair.pairId,
                type: 'word',
                value: pair.word
            }));
            
            const shuffledEmojis = shuffleArray([...emojis]);
            const shuffledWords = shuffleArray([...words]);
            
            if (gameState.mode === 'easy') {
                gameState.currentRound.leftColumn = shuffledEmojis;
                gameState.currentRound.rightColumn = shuffledWords;
            } else {
                gameState.currentRound.leftColumn = shuffledWords;
                gameState.currentRound.rightColumn = shuffledEmojis;
            }
            
            console.log('Generated pairs:', gameState.currentRound.pairs.map(p => `${p.word} (${p.pairId})`));
            console.log('Left Column:', gameState.currentRound.leftColumn.map(item => `${item.value} (${item.pairId})`));
            console.log('Right Column:', gameState.currentRound.rightColumn.map(item => `${item.value} (${item.pairId})`));
        }

        function getNewWords(count) {
            const vocab = window.vocab && window.vocab.length > 0 ? window.vocab : defaultVocab;
            const unseenWords = vocab
                .filter(item => !gameState.wordProgress[item.word])
                .map(item => item.word);
            
            if (unseenWords.length < count) {
                const seenWords = Object.keys(gameState.wordProgress).filter(word => gameState.wordProgress[word] < 3);
                const candidates = [...unseenWords, ...seenWords];
                return shuffleArray(candidates).slice(0, count);
            }
            
            return shuffleArray(unseenWords).slice(0, count);
        }

        function getReviewWords(count) {
            const reviewCandidates = Object.keys(gameState.wordProgress)
                .filter(word => gameState.wordProgress[word] > 0 && gameState.wordProgress[word] < 3);
            
            if (reviewCandidates.length < count) {
                return getNewWords(count);
            }
            
            return shuffleArray(reviewCandidates).slice(0, count);
        }

        function setupClassicMode() {
            generateRoundData();
            const gameBoard = document.getElementById('game-board');
            gameBoard.className = 'game-board';
            
            const leftColumn = document.createElement('div');
            leftColumn.className = 'column';
            leftColumn.id = 'column-left';
            
            const rightColumn = document.createElement('div');
            rightColumn.className = 'column';
            rightColumn.id = 'column-right';
            
            gameBoard.appendChild(leftColumn);
            gameBoard.appendChild(rightColumn);
            
            updateGameUI();
        }

        function updateGameUI() {
            document.getElementById('score').textContent = gameState.player.points;
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('progress').textContent = gameState.completedWords;
            document.getElementById('completed').textContent = gameState.completedWords;
            document.getElementById('percent-complete').textContent = Math.round((gameState.completedWords / 50) * 100);
            updateProgressBar();
            updateRewardPath();
            
            const leftColumn = document.getElementById('column-left');
            const rightColumn = document.getElementById('column-right');
            leftColumn.innerHTML = '';
            rightColumn.innerHTML = '';
            
            gameState.currentRound.leftColumn.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `card ${item.type === 'emoji' ? 'emoji-card' : 'word-card'}`;
                card.dataset.pairId = item.pairId;
                card.dataset.type = item.type;
                card.textContent = item.value;
                card.tabIndex = gameState.currentRound.matchedPairs.includes(item.pairId) ? -1 : 0;
                card.setAttribute('role', 'button');
                card.setAttribute('aria-label', `Seleccionar tarjeta: ${item.value}`);
                
                if (gameState.currentRound.matchedPairs.includes(item.pairId)) {
                    card.classList.add('matched');
                }
                
                const pair = gameState.currentRound.pairs.find(p => p.pairId === item.pairId);
                if (pair && gameState.wordProgress[pair.word]) {
                    card.classList.add(`word-mastery-${Math.min(3, gameState.wordProgress[pair.word])}`);
                }
                
                card.addEventListener('click', () => handleCardClick('left', item.pairId, index));
                card.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') handleCardClick('left', item.pairId, index);
                });
                
                leftColumn.appendChild(card);
            });
            
            gameState.currentRound.rightColumn.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `card ${item.type === 'emoji' ? 'emoji-card' : 'word-card'}`;
                card.dataset.pairId = item.pairId;
                card.dataset.type = item.type;
                card.textContent = item.value;
                card.tabIndex = gameState.currentRound.matchedPairs.includes(item.pairId) ? -1 : 0;
                card.setAttribute('role', 'button');
                card.setAttribute('aria-label', `Seleccionar tarjeta: ${item.value}`);
                
                if (gameState.currentRound.matchedPairs.includes(item.pairId)) {
                    card.classList.add('matched');
                }
                
                const pair = gameState.currentRound.pairs.find(p => p.pairId === item.pairId);
                if (pair && gameState.wordProgress[pair.word]) {
                    card.classList.add(`word-mastery-${Math.min(3, gameState.wordProgress[pair.word])}`);
                }
                
                card.addEventListener('click', () => handleCardClick('right', item.pairId, index));
                card.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') handleCardClick('right', item.pairId, index);
                });
                
                rightColumn.appendChild(card);
            });
            
            if (gameState.currentRound.matchedPairs.length === gameState.currentRound.pairs.length) {
                console.log('All pairs matched, ending round');
                endRound();
            }
        }

        function updateProgressBar() {
            const progressBar = document.querySelector('.progress-bar');
            const percent = Math.min(100, (gameState.completedWords / 50) * 100);
            progressBar.style.width = `${percent}%`;
        }

        function handleCardClick(column, pairId, index) {
            if (isProcessingClick || gameState.currentRound.matchedPairs.includes(pairId)) {
                console.log(`Skipped click: isProcessing=${isProcessingClick}, pairId=${pairId}, matched=${gameState.currentRound.matchedPairs.includes(pairId)}`);
                return;
            }
            isProcessingClick = true;
            
            const columnData = column === 'left' ? gameState.currentRound.leftColumn : gameState.currentRound.rightColumn;
            const item = columnData[index];
            if (!item || item.pairId !== pairId) {
                console.error(`Item mismatch: pairId=${pairId}, index=${index}, column=${column}, found=${!!item}`);
                isProcessingClick = false;
                showError("¡Vaya! Algo salió mal. ¡Inténtalo de nuevo!");
                return;
            }
            
            const card = document.querySelector(`.card[data-pair-id="${pairId}"][data-type="${item.type}"]`);
            if (!card || card.classList.contains('matched')) {
                console.error(`Invalid card: pairId=${pairId}, type=${item.type}, column=${column}, found=${!!card}`);
                isProcessingClick = false;
                showError("¡Vaya! Algo salió mal. ¡Inténtalo de nuevo!");
                return;
            }
            
            if (gameState.mode !== 'hard' && column === 'left') {
                const pair = gameState.currentRound.pairs.find(p => p.pairId === pairId);
                if (pair) {
                    const now = Date.now();
                    if (now - lastTTSTime >= ttsDebounce) {
                        speakWord(pair.word);
                        lastTTSTime = now;
                        console.log(`TTS triggered: word=${pair.word}`);
                    }
                }
            }
            
            if (column === 'left') {
                if (gameState.currentRound.selectedLeft) {
                    const prevCard = document.querySelector(`.card[data-pair-id="${gameState.currentRound.selectedLeft}"]`);
                    if (prevCard) prevCard.classList.remove('selected');
                }
                gameState.currentRound.selectedLeft = pairId;
                card.classList.add('selected');
            } else {
                if (gameState.currentRound.selectedRight) {
                    const prevCard = document.querySelector(`.card[data-pair-id="${gameState.currentRound.selectedRight}"]`);
                    if (prevCard) prevCard.classList.remove('selected');
                }
                gameState.currentRound.selectedRight = pairId;
                card.classList.add('selected');
            }
            
            console.log(`Selected: left=${gameState.currentRound.selectedLeft}, right=${gameState.currentRound.selectedRight}`);
            
            if (gameState.currentRound.selectedLeft && gameState.currentRound.selectedRight) {
                checkMatch();
            } else {
                isProcessingClick = false;
            }
        }

        function checkMatch() {
            const leftId = gameState.currentRound.selectedLeft;
            const rightId = gameState.currentRound.selectedRight;
            
            console.log(`Checking match: leftId=${leftId}, rightId=${rightId}, matchedPairs=${gameState.currentRound.matchedPairs.length}`);
            
            const leftCard = document.querySelector(`.card[data-pair-id="${leftId}"]`);
            const rightCard = document.querySelector(`.card[data-pair-id="${rightId}"]`);
            
            if (!leftCard || !rightCard) {
                console.error(`Cards not found in checkMatch: leftCard=${leftCard}, rightCard=${rightCard}, leftId=${leftId}, rightId=${rightId}`);
                resetSelections();
                showError("¡Vaya! Algo salió mal. ¡Inténtalo de nuevo!");
                return;
            }
            
            if (leftId === rightId) {
                leftCard.classList.add('correct');
                rightCard.classList.add('correct');
                
                gameState.player.points += 10;
                gameState.streak++;
                gameState.currentRound.roundPoints += 10;
                
                const pair = gameState.currentRound.pairs.find(p => p.pairId === leftId);
                if (pair) {
                    gameState.wordProgress[pair.word] = (gameState.wordProgress[pair.word] || 0) + 1;
                    if (gameState.wordProgress[pair.word] === 3) {
                        gameState.completedWords++;
                        checkMilestone();
                        checkModeCompletion();
                        checkStickerUnlock();
                    }
                }
                
                gameState.currentRound.matchedPairs.push(leftId);
                console.log(`Match successful, matchedPairs=${gameState.currentRound.matchedPairs.length}`);
                
                if (gameState.streak % 5 === 0) {
                    const bonus = gameState.streak * 2;
                    gameState.player.points += bonus;
                    showNotification(`¡Bonus de Racha: +${bonus} Puntos!`);
                }
                
                checkEmojiPurchase();
                
                setTimeout(() => {
                    leftCard.classList.remove('correct');
                    rightCard.classList.remove('correct');
                    leftCard.classList.add('matched');
                    rightCard.classList.add('matched');
                    leftCard.tabIndex = -1;
                    rightCard.tabIndex = -1;
                    gameState.currentRound.selectedLeft = null;
                    gameState.currentRound.selectedRight = null;
                    isProcessingClick = false;
                    
                    if (gameState.currentRound.matchedPairs.length === gameState.currentRound.pairs.length) {
                        console.log('All pairs matched, ending round');
                        endRound();
                    } else {
                        updateGameUI();
                    }
                }, 500);
            } else {
                leftCard.classList.add('incorrect');
                rightCard.classList.add('incorrect');
                
                gameState.streak = 0;
                
                setTimeout(() => {
                    leftCard.classList.remove('selected', 'incorrect');
                    rightCard.classList.remove('selected', 'incorrect');
                    gameState.currentRound.selectedLeft = null;
                    gameState.currentRound.selectedRight = null;
                    isProcessingClick = false;
                    updateGameUI();
                }, 1000);
            }
            
            savePlayerProgress();
        }

        function checkStickerUnlock() {
            const stickers = [
                { emoji: '⭐', unlocked: true, points: 0 },
                { emoji: '🎯', unlocked: true, points: 0 },
                { emoji: '🏅', unlocked: false, points: 100 },
                { emoji: '🏆', unlocked: false, points: 500 },
                { emoji: '👑', unlocked: false, points: 1000 },
                { emoji: '🎖️', unlocked: false, points: 1500 },
                { emoji: '🎉', unlocked: false, points: 2000 },
                { emoji: '🏅', unlocked: false, points: 2500 },
                { emoji: '🏆', unlocked: false, points: 3000 },
                { emoji: '👑', unlocked: false, points: 5000 }
            ];
            
            const stickerToUnlock = stickers.find(sticker => 
                !gameState.player.unlockedStickers.includes(sticker.emoji) && 
                gameState.player.points >= sticker.points
            );
            
            if (stickerToUnlock) {
                gameState.player.unlockedStickers.push(stickerToUnlock.emoji);
                showNotification(`¡Nueva pegatina desbloqueada: ${stickerToUnlock.emoji}!`);
                updateStickerCollection();
                savePlayerProgress();
            }
        }

        function resetSelections() {
            gameState.currentRound.selectedLeft = null;
            gameState.currentRound.selectedRight = null;
            document.querySelectorAll('.card.selected').forEach(card => card.classList.remove('selected'));
            isProcessingClick = false;
            updateGameUI();
        }

        function checkMilestone() {
            const previousWords = gameState.completedWords - 1;
            const currentWords = gameState.completedWords;
            if (milestones.includes(currentWords) && !milestones.includes(previousWords)) {
                showNotification(`¡Logro! ${currentWords}/50 palabras dominadas`);
                createConfetti(document.getElementById('game-screen'), 20);
                document.getElementById('character').style.animation = 'bounce 0.5s 3';
                setTimeout(() => {
                    document.getElementById('character').style.animation = 'bounce 2s infinite';
                }, 1500);
            }
        }

        function checkModeCompletion() {
            if (gameState.completedWords >= 50) {
                const modeRewards = gameState.player.rewards[gameState.mode];
                modeRewards.medals++;
                showNotification(`🎖️ ¡Medalla de ${gameState.mode} ganada!`);
                createConfetti(document.getElementById('game-screen'), 20);
                
                if (modeRewards.medals >= 5) {
                    modeRewards.medals = 0;
                    modeRewards.trophies++;
                    showNotification(`🏆 ¡Trofeo de ${gameState.mode} ganado!`);
                    createConfetti(document.getElementById('game-screen'), 20);
                }
                
                if (modeRewards.trophies >= 5) {
                    modeRewards.trophies = 0;
                    modeRewards.crowns++;
                    showNotification(`👑 ¡Corona de ${gameState.mode} ganada!`);
                    createConfetti(document.getElementById('game-screen'), 20);
                }
                
                savePlayerProgress();
            }
        }

        function checkEmojiPurchase() {
            const emojiStore = [
                { emoji: '🍊', points: 50, name: 'Naranja' },
                { emoji: '🏺', points: 75, name: 'Cántaro' },
                { emoji: '🥘', points: 100, name: 'Paella' },
                { emoji: '🌮', points: 125, name: 'Taco' },
                { emoji: '🍷', points: 150, name: 'Vino' },
                { emoji: '🎸', points: 175, name: 'Guitarra' },
                { emoji: '💃', points: 200, name: 'Bailarina' },
                { emoji: '🌵', points: 300, name: 'Cactus' },
                { emoji: '🦂', points: 400, name: 'Alacrán' },
                { emoji: '🏰', points: 500, name: 'Castillo' },
                { emoji: '⛪', points: 600, name: 'Catedral' },
                { emoji: '🎭', points: 700, name: 'Teatro' },
                { emoji: '🪕', points: 800, name: 'Charango' },
                { emoji: '🥁', points: 900, name: 'Cajón' },
                { emoji: '🗿', points: 1000, name: 'Moai' },
                { emoji: '🌋', points: 1200, name: 'Volcán' },
                { emoji: '🏆', points: 1500, name: 'Trofeo de Torero' },
                { emoji: '🎪', points: 1800, name: 'Feria' },
                { emoji: '🛶', points: 2000, name: 'Canoa' },
                { emoji: '🏺', points: 2200, name: 'Ánfora' },
                { emoji: '🕌', points: 2500, name: 'Alhambra' },
                { emoji: '👑', points: 3000, name: 'Corona Real' },
                { emoji: '💎', points: 3500, name: 'Esmeralda' },
                { emoji: '🏇', points: 4000, name: 'Caballo Andaluz' },
                { emoji: '🛕', points: 4500, name: 'Templo Maya' },
                { emoji: '🏟️', points: 5000, name: 'Plaza de Toros' },
                { emoji: '🎻', points: 6000, name: 'Stradivarius' },
                { emoji: '🖼️', points: 7000, name: 'Obra de Goya' },
                { emoji: '⚜️', points: 8000, name: 'Flor de Lis' },
                { emoji: '🏰', points: 9000, name: 'Alcázar' },
                { emoji: '🛡️', points: 10000, name: 'Escudo de los Reyes Católicos' },
                { emoji: '📜', points: 12000, name: 'Carta de Colón' },
                { emoji: '🗡️', points: 15000, name: 'Espada de El Cid' },
                { emoji: '🏛️', points: 20000, name: 'Acueducto de Segovia' },
                { emoji: '👑', points: 25000, name: 'Corona de Isabel la Católica' },
                { emoji: '🪙', points: 30000, name: 'Doblón de Oro' },
                { emoji: '🏆', points: 50000, name: 'Trofeo de la Copa del Rey' }
            ];

            const affordableEmojis = emojiStore.filter(item => !gameState.player.purchasedEmojis.includes(item.emoji) && gameState.player.points >= item.points);
            if (affordableEmojis.length > 0) {
                const emoji = affordableEmojis[0];
                gameState.player.purchasedEmojis.push(emoji.emoji);
                gameState.player.emoji = emoji.emoji;
                gameState.player.points -= emoji.points;
                showNotification(`¡Comprado emoji ${emoji.name} ${emoji.emoji}!`);
                updatePlayerUI();
                savePlayerProgress();
            }
        }

        function endRound() {
            if (gameState.currentRound.roundPoints === gameState.currentRound.pairs.length * 10) {
                gameState.player.points += 50;
                showNotification('¡Ronda perfecta! +50 puntos');
            }
            
            document.getElementById('round-score').textContent = gameState.currentRound.roundPoints;
            document.getElementById('total-score').textContent = gameState.player.points;
            document.getElementById('progress-count').textContent = gameState.completedWords;
            document.getElementById('progress-streak').textContent = gameState.streak;
            
            updateTrophyDisplay(document.getElementById('trophy-display'));
            updateRewardPath();
            
            savePlayerProgress();
            checkEmojiPurchase();
            
            setTimeout(() => {
                createConfetti(document.getElementById('round-complete-screen'), 20);
                showScreen('roundComplete');
            }, 1000);
            
            if (gameState.completedWords >= 50) {
                endGame();
            }
        }

        function showTrophyRoom() {
            const trophyList = document.getElementById('trophy-list');
            trophyList.innerHTML = '';
            
            const modes = ['easy', 'medium', 'hard'];
            modes.forEach(mode => {
                const rewards = gameState.player.rewards[mode];
                const modeName = mode.charAt(0).toUpperCase() + mode.slice(1);
                
                if (rewards.medals > 0 || rewards.trophies > 0 || rewards.crowns > 0) {
                    const modeHeader = document.createElement('h4');
                    modeHeader.textContent = `Modo ${modeName}`;
                    trophyList.appendChild(modeHeader);
                    
                    const modeContainer = document.createElement('div');
                    modeContainer.style.display = 'flex';
                    modeContainer.style.flexWrap = 'wrap';
                    modeContainer.style.justifyContent = 'center';
                    
                    if (rewards.medals > 0) {
                        const medalDiv = document.createElement('div');
                        medalDiv.className = 'trophy-item';
                        medalDiv.textContent = '🎖️';
                        medalDiv.title = `${rewards.medals} Medallas de ${modeName}`;
                        modeContainer.appendChild(medalDiv);
                    }
                    if (rewards.trophies > 0) {
                        const trophyDiv = document.createElement('div');
                        trophyDiv.className = 'trophy-item';
                        trophyDiv.textContent = '🏆';
                        trophyDiv.title = `${rewards.trophies} Trofeos de ${modeName}`;
                        modeContainer.appendChild(trophyDiv);
                    }
                    if (rewards.crowns > 0) {
                        const crownDiv = document.createElement('div');
                        crownDiv.className = 'trophy-item';
                        crownDiv.textContent = '👑';
                        crownDiv.title = `${rewards.crowns} Coronas de ${modeName}`;
                        modeContainer.appendChild(crownDiv);
                    }
                    
                    trophyList.appendChild(modeContainer);
                }
            });
            
            if (trophyList.innerHTML === '') {
                trophyList.textContent = '¡No hay recompensas todavía! ¡Sigue jugando!';
            }
            
            updateStickerCollection();
            showScreen('trophyRoom');
        }

        function updateTrophyDisplay(container) {
            container.innerHTML = '';
            const modes = ['easy', 'medium', 'hard'];
            modes.forEach(mode => {
                const rewards = gameState.player.rewards[mode];
                const modeName = mode.charAt(0).toUpperCase() + mode.slice(1);
                
                if (rewards.medals > 0) {
                    const medalDiv = document.createElement('div');
                    medalDiv.className = 'trophy-item';
                    medalDiv.textContent = '🎖️';
                    medalDiv.title = `${rewards.medals} Medallas de ${modeName}`;
                    container.appendChild(medalDiv);
                }
                if (rewards.trophies > 0) {
                    const trophyDiv = document.createElement('div');
                    trophyDiv.className = 'trophy-item';
                    trophyDiv.textContent = '🏆';
                    trophyDiv.title = `${rewards.trophies} Trofeos de ${modeName}`;
                    container.appendChild(trophyDiv);
                }
                if (rewards.crowns > 0) {
                    const crownDiv = document.createElement('div');
                    crownDiv.className = 'trophy-item';
                    crownDiv.textContent = '👑';
                    crownDiv.title = `${rewards.crowns} Coronas de ${modeName}`;
                    container.appendChild(crownDiv);
                }
            });
            
            if (container.innerHTML === '') {
                container.textContent = '¡Gana recompensas dominando palabras!';
            }
        }

        function showEmojiStore() {
            const emojiList = document.getElementById('emoji-list');
            emojiList.innerHTML = '';
            document.getElementById('store-points').textContent = gameState.player.points;
            
            const emojiStore = [
                { emoji: '🍊', points: 50, name: 'Naranja' },
                { emoji: '🏺', points: 75, name: 'Cántaro' },
                { emoji: '🥘', points: 100, name: 'Paella' },
                { emoji: '🌮', points: 125, name: 'Taco' },
                { emoji: '🍷', points: 150, name: 'Vino' },
                { emoji: '🎸', points: 175, name: 'Guitarra' },
                { emoji: '💃', points: 200, name: 'Bailarina' },
                { emoji: '🌵', points: 300, name: 'Cactus' },
                { emoji: '🦂', points: 400, name: 'Alacrán' },
                { emoji: '🏰', points: 500, name: 'Castillo' },
                { emoji: '⛪', points: 600, name: 'Catedral' },
                { emoji: '🎭', points: 700, name: 'Teatro' },
                { emoji: '🪕', points: 800, name: 'Charango' },
                { emoji: '🥁', points: 900, name: 'Cajón' },
                { emoji: '🗿', points: 1000, name: 'Moai' },
                { emoji: '🌋', points: 1200, name: 'Volcán' },
                { emoji: '🏆', points: 1500, name: 'Trofeo de Torero' },
                { emoji: '🎪', points: 1800, name: 'Feria' },
                { emoji: '🛶', points: 2000, name: 'Canoa' },
                { emoji: '🏺', points: 2200, name: 'Ánfora' },
                { emoji: '🕌', points: 2500, name: 'Alhambra' },
                { emoji: '👑', points: 3000, name: 'Corona Real' },
                { emoji: '💎', points: 3500, name: 'Esmeralda' },
                { emoji: '🏇', points: 4000, name: 'Caballo Andaluz' },
                { emoji: '🛕', points: 4500, name: 'Templo Maya' },
                { emoji: '🏟️', points: 5000, name: 'Plaza de Toros' },
                { emoji: '🎻', points: 6000, name: 'Stradivarius' },
                { emoji: '🖼️', points: 7000, name: 'Obra de Goya' },
                { emoji: '⚜️', points: 8000, name: 'Flor de Lis' },
                { emoji: '🏰', points: 9000, name: 'Alcázar' },
                { emoji: '🛡️', points: 10000, name: 'Escudo de los Reyes Católicos' },
                { emoji: '📜', points: 12000, name: 'Carta de Colón' },
                { emoji: '🗡️', points: 15000, name: 'Espada de El Cid' },
                { emoji: '🏛️', points: 20000, name: 'Acueducto de Segovia' },
                { emoji: '👑', points: 25000, name: 'Corona de Isabel la Católica' },
                { emoji: '🪙', points: 30000, name: 'Doblón de Oro' },
                { emoji: '🏆', points: 50000, name: 'Trofeo de la Copa del Rey' }
            ];

            emojiStore.forEach(item => {
                const div = document.createElement('div');
                div.className = `emoji-item ${gameState.player.purchasedEmojis.includes(item.emoji) ? 'purchased' : ''}`;
                div.innerHTML = `${item.emoji} ${item.name} (${item.points} Puntos)`;
                div.setAttribute('role', 'button');
                div.setAttribute('aria-label', `Seleccionar emoji ${item.name}`);
                if (!gameState.player.purchasedEmojis.includes(item.emoji) && gameState.player.points >= item.points) {
                    div.addEventListener('click', () => {
                        gameState.player.purchasedEmojis.push(item.emoji);
                        gameState.player.emoji = item.emoji;
                        gameState.player.points -= item.points;
                        savePlayerProgress();
                        showEmojiStore();
                        updatePlayerUI();
                        showNotification(`¡Comprado emoji ${item.name} ${item.emoji}!`);
                    });
                }
                emojiList.appendChild(div);
            });
            
            showScreen('emojiStore');
        }

        function endGame() {
            gameState.leaderboard.push({
                name: gameState.player.name,
                avatar: gameState.player.avatar,
                score: gameState.player.points,
                date: new Date().toISOString()
            });
            
            gameState.leaderboard.sort((a, b) => b.score - a.score);
            gameState.leaderboard = gameState.leaderboard.slice(0, 20);
            
            try {
                localStorage.setItem('nandomodeLeaderboard', JSON.stringify(gameState.leaderboard));
            } catch (e) {
                console.warn("Error saving leaderboard:", e);
                showError("No se pudo guardar el marcador. ¡Inténtalo de nuevo!");
            }
            
            document.getElementById('final-score').textContent = gameState.player.points;
            updateTrophyDisplay(document.getElementById('final-trophy-display'));
            
            // Unlock special sticker for completing the game
            if (!gameState.player.unlockedStickers.includes('🎉')) {
                gameState.player.unlockedStickers.push('🎉');
                showNotification('¡Pegatina especial desbloqueada: 🎉!');
                savePlayerProgress();
            }
            
            showScreen('gameOver');
        }

        function quitToMainMenu() {
            showScreen('start');
            populateUserSelect();
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
            gameState.currentScreen = screenName;
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function createConfetti(container, count) {
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ffbe0b', '#fb5607', '#8338ec'];
            
            for (let i = 0; i < Math.min(count, 20); i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = `${Math.random() * 1 + 1}s`;
                confetti.style.width = `${Math.random() * 6 + 4}px`;
                confetti.style.height = `${Math.random() * 6 + 4}px`;
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 2000);
            }
        }

        function speakWord(word) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'es-ES';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            } else {
                console.warn("SpeechSynthesis not supported.");
            }
        }

        function sanitizePairId(word) {
            return word.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
    </script>
</body>
</html>
